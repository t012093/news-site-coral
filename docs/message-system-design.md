# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ©Ÿèƒ½ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­è¨ˆæ›¸

## æ¦‚è¦

ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°æ©Ÿèƒ½ã®åŒ…æ‹¬çš„ãªãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼é–“ã®1å¯¾1ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã€å‹é”ç”³è«‹ã‚·ã‚¹ãƒ†ãƒ ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ã‚’å«ã‚€ã€‚

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend      â”‚    â”‚   Backend       â”‚    â”‚   Database      â”‚
â”‚   (React)       â”‚â—„â”€â”€â–ºâ”‚   (Node.js)     â”‚â—„â”€â”€â–ºâ”‚  (PostgreSQL)   â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚WebSocket    â”‚ â”‚â—„â”€â”€â–ºâ”‚ â”‚Socket.io    â”‚ â”‚    â”‚ â”‚Messages     â”‚ â”‚
â”‚ â”‚Client       â”‚ â”‚    â”‚ â”‚Server       â”‚ â”‚    â”‚ â”‚Conversationsâ”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â”‚Users        â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚Friendships  â”‚ â”‚
                                               â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚   Redis         â”‚
                       â”‚   (Cache)       â”‚
                       â”‚                 â”‚
                       â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                       â”‚ â”‚Session      â”‚ â”‚
                       â”‚ â”‚Cache        â”‚ â”‚
                       â”‚ â”‚Online Users â”‚ â”‚
                       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 

#### 1. users ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ—¢å­˜ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã¨çµ±åˆï¼‰
```sql
-- æ—¢å­˜ã®usersãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ‹¡å¼µã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ©Ÿèƒ½ã«å¯¾å¿œ
-- account-system-design.mdã§å®šç¾©æ¸ˆã¿ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä»¥ä¸‹ã®ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 

ALTER TABLE users ADD COLUMN IF NOT EXISTS is_online BOOLEAN DEFAULT false;
ALTER TABLE users ADD COLUMN IF NOT EXISTS last_seen TIMESTAMP WITH TIME ZONE;

-- privacy_settingsã®JSONBã«ä»¥ä¸‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–¢é€£è¨­å®šã‚’è¿½åŠ 
-- æ—¢å­˜: preferences.notifications (ãƒ¡ãƒ¼ãƒ«ãƒ»ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥è¨­å®š)
-- è¿½åŠ : preferences.messaging (ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°è¨­å®š)
```

**çµ±åˆã•ã‚ŒãŸprivacy_settingsæ§‹é€ **:
```typescript
interface UserPreferences {
  language: 'ja' | 'en';
  timezone: string;
  theme: 'light' | 'dark' | 'auto';
  notifications: {
    email: boolean;
    push: boolean;
    sms: boolean;
    frequency: 'immediate' | 'daily' | 'weekly';
    categories: {
      events: boolean;
      newsletter: boolean;
      projects: boolean;
      system: boolean;
      messages: boolean;      // ğŸ†• ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šçŸ¥
      friend_requests: boolean; // ğŸ†• å‹é”ç”³è«‹é€šçŸ¥
    };
  };
  messaging: {                 // ğŸ†• ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°è¨­å®š
    allow_messages_from: 'everyone' | 'friends_only' | 'nobody';
    show_online_status: boolean;
    show_last_seen: boolean;
    allow_friend_requests: boolean;
    read_receipts: boolean;
  };
}
```

```sql
CREATE INDEX idx_users_online ON users(is_online);
CREATE INDEX idx_users_last_seen ON users(last_seen);
```

#### 2. friendships ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE friendships (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    requester_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    addressee_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    status VARCHAR(20) NOT NULL DEFAULT 'pending', -- pending, accepted, rejected, blocked
    message TEXT, -- ç”³è«‹æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(requester_id, addressee_id),
    CHECK (requester_id != addressee_id),
    CHECK (status IN ('pending', 'accepted', 'rejected', 'blocked'))
);

CREATE INDEX idx_friendships_requester ON friendships(requester_id);
CREATE INDEX idx_friendships_addressee ON friendships(addressee_id);
CREATE INDEX idx_friendships_status ON friendships(status);
```

#### 3. conversations ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    type VARCHAR(20) NOT NULL DEFAULT 'direct', -- direct, group (å°†æ¥æ‹¡å¼µç”¨)
    title VARCHAR(255), -- ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆç”¨
    last_message_id UUID,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CHECK (type IN ('direct', 'group'))
);

CREATE INDEX idx_conversations_updated_at ON conversations(updated_at DESC);
```

#### 4. conversation_participants ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE conversation_participants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    joined_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    left_at TIMESTAMP WITH TIME ZONE,
    last_read_message_id UUID,
    unread_count INTEGER DEFAULT 0,
    is_muted BOOLEAN DEFAULT false,
    
    UNIQUE(conversation_id, user_id)
);

CREATE INDEX idx_conversation_participants_user ON conversation_participants(user_id);
CREATE INDEX idx_conversation_participants_conversation ON conversation_participants(conversation_id);
```

#### 5. messages ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
    sender_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    message_type VARCHAR(20) NOT NULL DEFAULT 'text', -- text, image, file, system
    reply_to_id UUID REFERENCES messages(id),
    metadata JSONB, -- ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã€ç”»åƒã‚µã‚¤ã‚ºç­‰
    is_edited BOOLEAN DEFAULT false,
    edited_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CHECK (message_type IN ('text', 'image', 'file', 'system'))
);

CREATE INDEX idx_messages_conversation ON messages(conversation_id, created_at DESC);
CREATE INDEX idx_messages_sender ON messages(sender_id);
CREATE INDEX idx_messages_reply_to ON messages(reply_to_id);
```

#### 6. message_receipts ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE message_receipts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    message_id UUID NOT NULL REFERENCES messages(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    status VARCHAR(20) NOT NULL, -- delivered, read
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(message_id, user_id, status),
    CHECK (status IN ('delivered', 'read'))
);

CREATE INDEX idx_message_receipts_message ON message_receipts(message_id);
CREATE INDEX idx_message_receipts_user ON message_receipts(user_id);
```

## REST API è¨­è¨ˆ

### èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
```typescript
// JWTèªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼å¿…é ˆ
Authorization: Bearer <jwt_token>
```

### å‹é”ç”³è«‹ API

#### å‹é”ç”³è«‹é€ä¿¡
```
POST /api/friends/request
Content-Type: application/json

{
  "userId": "uuid",
  "message": "ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼"
}

Response:
{
  "success": true,
  "friendship": {
    "id": "uuid",
    "status": "pending",
    "createdAt": "2024-08-14T..."
  }
}
```

#### å‹é”ç”³è«‹ä¸€è¦§å–å¾—
```
GET /api/friends/requests?type=received&status=pending

Response:
{
  "requests": [
    {
      "id": "uuid",
      "requester": {
        "id": "uuid",
        "displayName": "ç”°ä¸­å¤ªéƒ",
        "avatar": "url"
      },
      "message": "ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼",
      "status": "pending",
      "createdAt": "2024-08-14T..."
    }
  ],
  "total": 1
}
```

#### å‹é”ç”³è«‹æ‰¿èª/æ‹’å¦
```
PUT /api/friends/request/:requestId
Content-Type: application/json

{
  "status": "accepted" // or "rejected"
}

Response:
{
  "success": true,
  "friendship": {
    "id": "uuid",
    "status": "accepted",
    "updatedAt": "2024-08-14T..."
  }
}
```

#### å‹é”ä¸€è¦§å–å¾—
```
GET /api/friends?search=ç”°ä¸­

Response:
{
  "friends": [
    {
      "id": "uuid",
      "displayName": "ç”°ä¸­å¤ªéƒ",
      "avatar": "url",
      "isOnline": true,
      "lastSeen": "2024-08-14T...",
      "friendship": {
        "id": "uuid",
        "createdAt": "2024-08-14T..."
      }
    }
  ],
  "total": 1
}
```

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ API

#### ä¼šè©±ä¸€è¦§å–å¾—
```
GET /api/conversations?limit=20&offset=0

Response:
{
  "conversations": [
    {
      "id": "uuid",
      "type": "direct",
      "participants": [
        {
          "id": "uuid",
          "displayName": "ç”°ä¸­å¤ªéƒ",
          "avatar": "url",
          "isOnline": true
        }
      ],
      "lastMessage": {
        "id": "uuid",
        "content": "ã“ã‚“ã«ã¡ã¯ï¼",
        "createdAt": "2024-08-14T...",
        "sender": {...}
      },
      "unreadCount": 2,
      "updatedAt": "2024-08-14T..."
    }
  ],
  "total": 1
}
```

#### ä¼šè©±ä½œæˆ/å–å¾—
```
POST /api/conversations
Content-Type: application/json

{
  "participantId": "uuid"
}

Response:
{
  "conversation": {
    "id": "uuid",
    "type": "direct",
    "participants": [...],
    "createdAt": "2024-08-14T..."
  }
}
```

#### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´å–å¾—
```
GET /api/conversations/:conversationId/messages?limit=50&before=messageId

Response:
{
  "messages": [
    {
      "id": "uuid",
      "content": "ã“ã‚“ã«ã¡ã¯ï¼",
      "messageType": "text",
      "sender": {
        "id": "uuid",
        "displayName": "ç”°ä¸­å¤ªéƒ",
        "avatar": "url"
      },
      "replyTo": null,
      "receipts": [
        {
          "userId": "uuid",
          "status": "read",
          "timestamp": "2024-08-14T..."
        }
      ],
      "createdAt": "2024-08-14T...",
      "isEdited": false
    }
  ],
  "hasMore": true
}
```

#### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
```
POST /api/conversations/:conversationId/messages
Content-Type: application/json

{
  "content": "ã“ã‚“ã«ã¡ã¯ï¼",
  "messageType": "text",
  "replyToId": "uuid" // optional
}

Response:
{
  "message": {
    "id": "uuid",
    "content": "ã“ã‚“ã«ã¡ã¯ï¼",
    "messageType": "text",
    "createdAt": "2024-08-14T...",
    "sender": {...}
  }
}
```

#### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ—¢èª­
```
PUT /api/messages/:messageId/read

Response:
{
  "success": true
}
```

### ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡ API

#### ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
```
POST /api/upload/message
Content-Type: multipart/form-data

FormData:
- file: File
- conversationId: string
- messageType: "image" | "file"

Response:
{
  "message": {
    "id": "uuid",
    "content": "ç”»åƒã‚’é€ä¿¡ã—ã¾ã—ãŸ",
    "messageType": "image",
    "metadata": {
      "filename": "image.jpg",
      "size": 1024000,
      "url": "https://...",
      "thumbnailUrl": "https://..."
    },
    "createdAt": "2024-08-14T..."
  }
}
```

## WebSocket é€šä¿¡è¨­è¨ˆ

### Socket.io ã‚¤ãƒ™ãƒ³ãƒˆè¨­è¨ˆ

#### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼

```typescript
// æ¥ç¶šæ™‚ã®èªè¨¼
socket.emit('authenticate', { token: 'jwt_token' });

// ä¼šè©±ã«å‚åŠ 
socket.emit('join_conversation', { conversationId: 'uuid' });

// ä¼šè©±ã‹ã‚‰é›¢è„±
socket.emit('leave_conversation', { conversationId: 'uuid' });

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
socket.emit('send_message', {
  conversationId: 'uuid',
  content: 'ã“ã‚“ã«ã¡ã¯ï¼',
  messageType: 'text',
  replyToId?: 'uuid'
});

// ã‚¿ã‚¤ãƒ”ãƒ³ã‚°çŠ¶æ…‹é€ä¿¡
socket.emit('typing_start', { conversationId: 'uuid' });
socket.emit('typing_stop', { conversationId: 'uuid' });

// ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹æ›´æ–°
socket.emit('status_update', { isOnline: true });
```

#### ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

```typescript
// èªè¨¼æˆåŠŸ
socket.on('authenticated', { userId: 'uuid', status: 'success' });

// æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
socket.on('message_received', {
  message: {
    id: 'uuid',
    conversationId: 'uuid',
    content: 'ã“ã‚“ã«ã¡ã¯ï¼',
    sender: {...},
    createdAt: '2024-08-14T...'
  }
});

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ—¢èª­é€šçŸ¥
socket.on('message_read', {
  messageId: 'uuid',
  userId: 'uuid',
  timestamp: '2024-08-14T...'
});

// ã‚¿ã‚¤ãƒ”ãƒ³ã‚°çŠ¶æ…‹å—ä¿¡
socket.on('user_typing', {
  conversationId: 'uuid',
  user: { id: 'uuid', displayName: 'ç”°ä¸­å¤ªéƒ' },
  isTyping: true
});

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹å¤‰æ›´
socket.on('user_status_changed', {
  userId: 'uuid',
  isOnline: true,
  lastSeen?: '2024-08-14T...'
});

// æ–°ã—ã„å‹é”ç”³è«‹
socket.on('friend_request_received', {
  request: {
    id: 'uuid',
    requester: {...},
    message: 'ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼',
    createdAt: '2024-08-14T...'
  }
});

// å‹é”ç”³è«‹æ‰¿èªé€šçŸ¥
socket.on('friend_request_accepted', {
  friendship: {
    id: 'uuid',
    friend: {...},
    createdAt: '2024-08-14T...'
  }
});
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### èªè¨¼ãƒ»èªå¯ï¼ˆçµ±åˆè¨­è¨ˆï¼‰
- **JWT ãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼**ï¼ˆå…¨ã‚·ã‚¹ãƒ†ãƒ å…±é€šï¼‰
- **Socket.io æ¥ç¶šæ™‚ã®èªè¨¼ç¢ºèª**
- **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ¨©é™ã®ç¢ºèª**ï¼ˆå‹é”é–¢ä¿‚ + ä¼šå“¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ï¼‰
- **ä¼šå“¡ã‚¿ã‚¤ãƒ—ã«ã‚ˆã‚‹æ©Ÿèƒ½åˆ¶é™**ï¼ˆaccount-system-design.mdã¨é€£æºï¼‰

### çµ±åˆã•ã‚ŒãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼
```typescript
// çµ±åˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ä¾‹
function canSendMessage(sender: User, receiver: User): boolean {
  // 1. ä¼šå“¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯
  if (sender.membershipInfo.status !== 'active') {
    return false;
  }
  
  // 2. ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®šãƒã‚§ãƒƒã‚¯
  const receiverSettings = receiver.preferences.messaging;
  if (receiverSettings.allow_messages_from === 'nobody') {
    return false;
  }
  
  // 3. å‹é”é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ï¼ˆfriends_onlyè¨­å®šã®å ´åˆï¼‰
  if (receiverSettings.allow_messages_from === 'friends_only') {
    return areFriends(sender.id, receiver.id);
  }
  
  // 4. ä¼šå“¡ã‚¿ã‚¤ãƒ—ã«ã‚ˆã‚‹åˆ¶é™ãƒã‚§ãƒƒã‚¯
  const limits = MESSAGING_LIMITS_BY_MEMBERSHIP[sender.membershipInfo.type];
  return checkDailyLimits(sender.id, limits);
}
```

### ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®šï¼ˆçµ±åˆç‰ˆï¼‰
```sql
-- æ—¢å­˜ã®UserPreferencesã«çµ±åˆã•ã‚ŒãŸprivacy_settings
-- account-system-design.mdã§å®šç¾©æ¸ˆã¿ã®æ§‹é€ ã‚’æ‹¡å¼µ
```

### ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆä¼šå“¡ã‚¿ã‚¤ãƒ—çµ±åˆç‰ˆï¼‰
```typescript
// ä¼šå“¡ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸå‹•çš„ãƒ¬ãƒ¼ãƒˆåˆ¶é™
function getMessageRateLimit(membershipType: MembershipType) {
  const limits = {
    general: { windowMs: 60 * 1000, max: 10 },
    supporting: { windowMs: 60 * 1000, max: 20 },
    regular: { windowMs: 60 * 1000, max: 50 },
    director: { windowMs: 60 * 1000, max: 100 }
  };
  
  return {
    ...limits[membershipType],
    message: 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™'
  };
}

// å‹é”ç”³è«‹åˆ¶é™ï¼ˆä¼šå“¡ã‚¿ã‚¤ãƒ—è€ƒæ…®ï¼‰
function getFriendRequestRateLimit(membershipType: MembershipType) {
  const limits = {
    general: { windowMs: 60 * 60 * 1000, max: 3 },
    supporting: { windowMs: 60 * 60 * 1000, max: 10 },
    regular: { windowMs: 60 * 60 * 1000, max: 25 },
    director: { windowMs: 60 * 60 * 1000, max: 50 }
  };
  
  return {
    ...limits[membershipType],
    message: 'å‹é”ç”³è«‹ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™'
  };
}
```

### ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
```typescript
// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
const messageSchema = {
  content: {
    type: 'string',
    minLength: 1,
    maxLength: 2000,
    required: true
  },
  messageType: {
    type: 'string',
    enum: ['text', 'image', 'file'],
    required: true
  }
};
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–
```sql
-- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
CREATE TABLE messages_2024_08 PARTITION OF messages
FOR VALUES FROM ('2024-08-01') TO ('2024-09-01');

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–
CREATE INDEX CONCURRENTLY idx_messages_conversation_created 
ON messages(conversation_id, created_at DESC) 
WHERE created_at > NOW() - INTERVAL '30 days';
```

### Redis ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
```typescript
// ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥
Redis.setex(`user:${userId}:online`, 300, 'true');

// æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã‚­ãƒ£ãƒƒã‚·ãƒ¥
Redis.setex(`user:${userId}:unread_count`, 60, unreadCount);

// ä¼šè©±å‚åŠ è€…ã‚­ãƒ£ãƒƒã‚·ãƒ¥
Redis.setex(`conversation:${conversationId}:participants`, 3600, 
  JSON.stringify(participants));
```

### Connection Poolè¨­å®š
```typescript
// PostgreSQLæ¥ç¶šãƒ—ãƒ¼ãƒ«
const pool = new Pool({
  host: process.env.DB_HOST,
  database: process.env.DB_NAME,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  port: 5432,
  max: 20, // æœ€å¤§æ¥ç¶šæ•°
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});
```

## ç›£è¦–ãƒ»ãƒ­ã‚®ãƒ³ã‚°

### ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
```typescript
// Prometheus ãƒ¡ãƒˆãƒªã‚¯ã‚¹ä¾‹
const messagesSentTotal = new Counter({
  name: 'messages_sent_total',
  help: 'é€ä¿¡ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç·æ•°',
  labelNames: ['message_type']
});

const activeConnections = new Gauge({
  name: 'websocket_connections_active',
  help: 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªWebSocketæ¥ç¶šæ•°'
});
```

### ãƒ­ã‚°è¨­è¨ˆ
```typescript
// æ§‹é€ åŒ–ãƒ­ã‚°ä¾‹
logger.info('Message sent', {
  userId: 'uuid',
  conversationId: 'uuid',
  messageType: 'text',
  timestamp: new Date().toISOString()
});

logger.warn('Rate limit exceeded', {
  userId: 'uuid',
  endpoint: '/api/messages',
  rateLimitType: 'message_sending'
});
```

## ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè¨­è¨ˆ

### Docker Composeä¾‹
```yaml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/messages
      - REDIS_URL=redis://redis:6379
    depends_on:
      - db
      - redis

  db:
    image: postgres:15
    environment:
      POSTGRES_DB: messages
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

## ä»–ã‚·ã‚¹ãƒ†ãƒ ã¨ã®çµ±åˆ

### ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã¨ã®çµ±åˆ

#### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
```typescript
// ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨é€£å‹•ã—ãŸã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆ
interface ProjectConversation extends Conversation {
  projectId: string;  // task-management-production-design.mdã®projects.id
  taskId?: string;    // ç‰¹å®šã®ã‚¿ã‚¹ã‚¯ã«é–¢é€£ã™ã‚‹ä¼šè©±
  type: 'project_general' | 'task_specific';
}
```

#### ã‚¿ã‚¹ã‚¯é–¢é€£é€šçŸ¥ã®çµ±åˆ
```sql
-- ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®notificationsãƒ†ãƒ¼ãƒ–ãƒ«ã¨çµ±åˆ
ALTER TABLE notifications ADD COLUMN IF NOT EXISTS source_system VARCHAR(20) DEFAULT 'messaging';
-- 'messaging', 'task_management', 'general'ãªã©

-- ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ã®è‡ªå‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹
INSERT INTO messages (conversation_id, sender_id, content, message_type)
SELECT 
  pc.conversation_id,
  'system' as sender_id,
  CONCAT('ã‚¿ã‚¹ã‚¯ã€Œ', t.title, 'ã€ãŒå®Œäº†ã—ã¾ã—ãŸï¼ğŸ‰') as content,
  'system' as message_type
FROM project_conversations pc
JOIN tasks t ON pc.project_id = t.project_id
WHERE t.status = 'completed';
```

#### å…±é€šAPIè¨­è¨ˆã®çµ±åˆ
```typescript
// çµ±ä¸€ã•ã‚ŒãŸJWT Payload
interface UnifiedJWTPayload {
  userId: string;
  email: string;
  displayName: string;
  
  // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®æ¨©é™
  membershipType: 'general' | 'supporting' | 'regular' | 'director';
  
  // ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®æ¨©é™
  projectRoles: Record<string, 'owner' | 'admin' | 'member' | 'viewer'>;
  
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°æ¨©é™
  messagingPermissions: {
    canSendMessages: boolean;
    canCreateGroups: boolean;
    maxFileSize: number;
  };
  
  iat: number;
  exp: number;
}
```

### ä¼šå“¡ã‚·ã‚¹ãƒ†ãƒ ã¨ã®çµ±åˆ

#### ä¼šå“¡ç‰¹å…¸ã¨ã—ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ©Ÿèƒ½
```typescript
// ä¼šå“¡ã‚¿ã‚¤ãƒ—ã«ã‚ˆã‚‹æ©Ÿèƒ½åˆ¶é™
const MESSAGING_LIMITS_BY_MEMBERSHIP = {
  general: {
    maxFriendsPerDay: 5,
    maxMessageLength: 1000,
    fileUploadSize: 5 * 1024 * 1024, // 5MB
    canCreateGroups: false
  },
  supporting: {
    maxFriendsPerDay: 15,
    maxMessageLength: 2000,
    fileUploadSize: 25 * 1024 * 1024, // 25MB
    canCreateGroups: true,
    maxGroupSize: 10
  },
  regular: {
    maxFriendsPerDay: 50,
    maxMessageLength: 5000,
    fileUploadSize: 100 * 1024 * 1024, // 100MB
    canCreateGroups: true,
    maxGroupSize: 50
  },
  director: {
    maxFriendsPerDay: -1, // ç„¡åˆ¶é™
    maxMessageLength: -1, // ç„¡åˆ¶é™
    fileUploadSize: 500 * 1024 * 1024, // 500MB
    canCreateGroups: true,
    maxGroupSize: 200
  }
};
```

## ä»Šå¾Œã®æ‹¡å¼µäºˆå®š

### ãƒ•ã‚§ãƒ¼ã‚º2: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€£æºå¼·åŒ–
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå°‚ç”¨ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ 
- ã‚¿ã‚¹ã‚¯é€²æ—ã®è‡ªå‹•é€šçŸ¥
- ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰ã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè³‡æ–™ã®çµ±åˆ

### ãƒ•ã‚§ãƒ¼ã‚º3: é«˜åº¦ãªæ©Ÿèƒ½
- éŸ³å£°ãƒ»ãƒ“ãƒ‡ã‚ªé€šè©±ï¼ˆWebRTCï¼‰
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æš—å·åŒ–
- è‡ªå‹•ç¿»è¨³æ©Ÿèƒ½
- ä¼šå“¡å‘ã‘ãƒœãƒƒãƒˆçµ±åˆ

### ãƒ•ã‚§ãƒ¼ã‚º4: ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºæ©Ÿèƒ½
- çµ„ç¹”ç®¡ç†ï¼ˆæ—¢å­˜ã®ä¼šå“¡ã‚·ã‚¹ãƒ†ãƒ ã¨é€£æºï¼‰
- ç›£æŸ»ãƒ­ã‚°
- ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒãƒªã‚·ãƒ¼
- ã‚·ãƒ³ã‚°ãƒ«ã‚µã‚¤ãƒ³ã‚ªãƒ³ï¼ˆSSOï¼‰

---

ã“ã®è¨­è¨ˆæ›¸ã¯ã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ã§å®‰å…¨ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã®åŸºç›¤ã‚’æä¾›ã—ã¾ã™ã€‚
æ®µéšçš„ãªå®Ÿè£…ã«ã‚ˆã‚Šã€åŸºæœ¬æ©Ÿèƒ½ã‹ã‚‰é«˜åº¦ãªæ©Ÿèƒ½ã¾ã§å¯¾å¿œå¯èƒ½ã§ã™ã€‚