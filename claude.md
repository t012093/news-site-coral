# CORAL çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­è¨ˆ

## æ¦‚è¦

CORALã‚µã‚¤ãƒˆã®çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­è¨ˆã§ã™ã€‚Headless WordPress CMSã«ã‚ˆã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç®¡ç†ã¨ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’çµ±åˆã—ã€ç·¨é›†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®åŠ¹ç‡åŒ–ã¨ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

## çµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Frontend (React 19)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Content CMS   â”‚    Project Management        â”‚
â”‚   (WordPress)   â”‚    (Custom Backend)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Unified Authentication (JWT)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    PostgreSQL   â”‚         Redis Cache          â”‚
â”‚  (Main Database)â”‚     (Session & Cache)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çµ±åˆã®åˆ©ç‚¹
- **Single Sign-On**: 1ã¤ã®èªè¨¼ã§å…¨æ©Ÿèƒ½åˆ©ç”¨
- **ç·¨é›†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: è¨˜äº‹åŸ·ç­†ã‚¿ã‚¹ã‚¯ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®é€£æº
- **çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç®¡ç†ã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã®ä¸€å…ƒåŒ–
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ**: è¨˜äº‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ã‚¿ã‚¹ã‚¯é€²æ—ã®å³æ™‚åæ˜ 

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ§‹æˆ
- **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: React 19 + TypeScript
- **ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«**: Vite 6.3.4
- **ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°**: Emotion (`@emotion/react`, `@emotion/styled`)
- **çŠ¶æ…‹ç®¡ç†**: React Query + Context API (çµ±åˆçŠ¶æ…‹ç®¡ç†)
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡**: Socket.io
- **ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**: React Router DOM 7.2.0
- **ãƒ‡ãƒ—ãƒ­ã‚¤**: Vercel

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ§‹æˆ
- **API Gateway**: Node.js + Express
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: PostgreSQL (çµ±åˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»ã‚¿ã‚¹ã‚¯)
- **CMS**: WordPress (Headless, ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å°‚ç”¨)
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: Redis
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ **: Socket.io
- **èªè¨¼**: JWT (çµ±åˆèªè¨¼ã‚·ã‚¹ãƒ†ãƒ )

---

# çµ±åˆèªè¨¼ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ

## çµ±ä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«è¨­è¨ˆ
```typescript
interface UnifiedUser {
  id: string;
  email: string;
  name: string;
  avatar_url?: string;
  wordpress_id?: number; // WordPressã¨ã®é€£æºç”¨
  roles: {
    cms: 'admin' | 'editor' | 'author' | 'contributor' | 'viewer';
    projects: 'owner' | 'admin' | 'manager' | 'member' | 'viewer';
  };
  permissions: string[]; // ['read:articles', 'write:articles', 'manage:projects']
  is_active: boolean;
  last_login: Date;
  created_at: Date;
  updated_at: Date;
}
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ
```sql
-- çµ±åˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE unified_users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(255) NOT NULL,
  avatar_url VARCHAR(500),
  wordpress_id INTEGER UNIQUE, -- WordPressãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  password_hash VARCHAR(255), -- çµ±åˆèªè¨¼ç”¨
  is_active BOOLEAN DEFAULT true,
  email_verified BOOLEAN DEFAULT false,
  last_login TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- æ¨©é™ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE user_permissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES unified_users(id) ON DELETE CASCADE,
  service VARCHAR(50) NOT NULL, -- 'cms' | 'projects'
  permission VARCHAR(100) NOT NULL, -- 'read:articles', 'manage:projects'
  granted_by UUID REFERENCES unified_users(id),
  granted_at TIMESTAMP DEFAULT NOW(),
  expires_at TIMESTAMP, -- æœŸé™ä»˜ãæ¨©é™
  UNIQUE(user_id, service, permission)
);

-- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE user_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES unified_users(id) ON DELETE CASCADE,
  token_hash VARCHAR(255) NOT NULL,
  device_info JSONB,
  ip_address INET,
  is_active BOOLEAN DEFAULT true,
  expires_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### JWTçµ±åˆè¨­è¨ˆ
```typescript
interface UnifiedJWT {
  sub: string; // user_id
  email: string;
  name: string;
  permissions: {
    cms: string[];      // ['read:articles', 'write:articles', 'manage:media']
    projects: string[]; // ['read:tasks', 'write:tasks', 'manage:projects']
  };
  wordpress_token?: string; // WordPress APIç”¨ãƒˆãƒ¼ã‚¯ãƒ³
  session_id: string;
  iat: number;
  exp: number;
}

// èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹
export class UnifiedAuthService {
  async login(email: string, password: string): Promise<{
    user: UnifiedUser;
    accessToken: string;
    refreshToken: string;
  }> {
    // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼
    const user = await this.authenticateUser(email, password);
    
    // 2. WordPressé€£æºç¢ºèª
    if (user.wordpress_id) {
      const wpToken = await this.getWordPressToken(user.wordpress_id);
      user.wordpress_token = wpToken;
    }
    
    // 3. æ¨©é™å–å¾—
    const permissions = await this.getUserPermissions(user.id);
    
    // 4. JWTç”Ÿæˆ
    const accessToken = this.generateAccessToken(user, permissions);
    const refreshToken = this.generateRefreshToken(user.id);
    
    // 5. ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²
    await this.createSession(user.id, refreshToken);
    
    return { user, accessToken, refreshToken };
  }

  private async getUserPermissions(userId: string): Promise<{
    cms: string[];
    projects: string[];
  }> {
    const permissions = await UserPermission.findAll({
      where: { userId, expiresAt: { [Op.or]: [null, { [Op.gt]: new Date() }] } }
    });

    return permissions.reduce((acc, perm) => {
      if (!acc[perm.service as keyof typeof acc]) {
        acc[perm.service as keyof typeof acc] = [];
      }
      acc[perm.service as keyof typeof acc].push(perm.permission);
      return acc;
    }, { cms: [] as string[], projects: [] as string[] });
  }
}
```

---

# çµ±åˆAPIè¨­è¨ˆ

## APIã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### çµ±åˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ§‹æˆ
```typescript
// çµ±åˆAPIãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
const apiRoutes = {
  // èªè¨¼é–¢é€£
  auth: {
    'POST /auth/login': 'UnifiedAuthController.login',
    'POST /auth/logout': 'UnifiedAuthController.logout',
    'POST /auth/refresh': 'UnifiedAuthController.refresh',
    'GET /auth/me': 'UnifiedAuthController.getProfile',
    'PUT /auth/profile': 'UnifiedAuthController.updateProfile'
  },

  // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç®¡ç† (WordPressçµ±åˆ)
  content: {
    'GET /api/articles': 'ContentController.getArticles',
    'GET /api/articles/:slug': 'ContentController.getArticle',
    'POST /api/articles': 'ContentController.createArticle',
    'PUT /api/articles/:id': 'ContentController.updateArticle',
    'DELETE /api/articles/:id': 'ContentController.deleteArticle',
    'GET /api/categories': 'ContentController.getCategories',
    'GET /api/media': 'ContentController.getMedia',
    'POST /api/media': 'ContentController.uploadMedia'
  },

  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†
  projects: {
    'GET /api/projects': 'ProjectController.getProjects',
    'POST /api/projects': 'ProjectController.createProject',
    'GET /api/projects/:id': 'ProjectController.getProject',
    'PUT /api/projects/:id': 'ProjectController.updateProject',
    'GET /api/projects/:id/tasks': 'ProjectController.getTasks',
    'GET /api/projects/:id/board': 'ProjectController.getKanbanBoard'
  },

  // ã‚¿ã‚¹ã‚¯ç®¡ç†
  tasks: {
    'GET /api/tasks': 'TaskController.getTasks',
    'POST /api/tasks': 'TaskController.createTask',
    'GET /api/tasks/:id': 'TaskController.getTask',
    'PUT /api/tasks/:id': 'TaskController.updateTask',
    'PATCH /api/tasks/:id/status': 'TaskController.updateStatus',
    'DELETE /api/tasks/:id': 'TaskController.deleteTask'
  },

  // çµ±åˆæ©Ÿèƒ½ (ç·¨é›†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼)
  editorial: {
    'POST /api/editorial/workflows': 'EditorialController.createWorkflow',
    'GET /api/editorial/workflows': 'EditorialController.getWorkflows',
    'GET /api/editorial/workflows/:id': 'EditorialController.getWorkflow',
    'PUT /api/editorial/workflows/:id': 'EditorialController.updateWorkflow',
    'POST /api/editorial/workflows/:id/advance': 'EditorialController.advanceStage'
  }
};
```

### çµ±åˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
```typescript
// æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
export const requirePermission = (permissions: string[]) => {
  return async (req: Request, res: Response, next: NextFunction) => {
    try {
      const token = req.headers.authorization?.replace('Bearer ', '');
      if (!token) {
        return res.status(401).json({ error: 'No token provided' });
      }

      const decoded = jwt.verify(token, JWT_SECRET) as UnifiedJWT;
      
      // æ¨©é™ãƒã‚§ãƒƒã‚¯
      const hasPermission = permissions.some(perm => {
        const [service] = perm.split(':');
        return decoded.permissions[service as keyof typeof decoded.permissions]?.includes(perm);
      });

      if (!hasPermission) {
        return res.status(403).json({ error: 'Insufficient permissions' });
      }

      req.user = decoded;
      next();
    } catch (error) {
      return res.status(401).json({ error: 'Invalid token' });
    }
  };
};

// WordPressçµ±åˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
export const withWordPressAuth = async (req: Request, res: Response, next: NextFunction) => {
  if (req.user?.wordpress_token) {
    // WordPressAPIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®š
    req.wpAPI = createWordPressClient({
      baseURL: WP_API_URL,
      headers: { Authorization: `Bearer ${req.user.wordpress_token}` }
    });
  }
  next();
};
```

## ç·¨é›†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çµ±åˆ

### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ
```typescript
// ç·¨é›†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å‹å®šç¾©
interface EditorialWorkflow {
  id: string;
  title: string;
  description: string;
  article_id?: number; // WordPressè¨˜äº‹ID
  article_slug?: string;
  project_id: string;
  assigned_author: string;
  assigned_editor?: string;
  stage: WorkflowStage;
  due_date: Date;
  priority: 'low' | 'medium' | 'high' | 'urgent';
  tags: string[];
  tasks: WorkflowTask[];
  created_at: Date;
  updated_at: Date;
}

type WorkflowStage = 
  | 'idea'        // ã‚¢ã‚¤ãƒ‡ã‚¢æ®µéš
  | 'planning'    // ä¼ç”»ãƒ»æ§‹æˆ
  | 'writing'     // åŸ·ç­†ä¸­
  | 'review'      // ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­
  | 'editing'     // ç·¨é›†ä¸­
  | 'approval'    // æ‰¿èªå¾…ã¡
  | 'scheduled'   // å…¬é–‹äºˆç´„
  | 'published'   // å…¬é–‹æ¸ˆã¿
  | 'archived';   // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–

interface WorkflowTask {
  id: string;
  workflow_id: string;
  task_id: string; // ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¿ã‚¹ã‚¯ID
  stage: WorkflowStage;
  title: string;
  is_required: boolean;
  is_completed: boolean;
  assigned_to?: string;
  due_date?: Date;
}
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ
```sql
-- ç·¨é›†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE editorial_workflows (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(500) NOT NULL,
  description TEXT,
  article_id INTEGER, -- WordPressã®è¨˜äº‹ID
  article_slug VARCHAR(255),
  project_id UUID REFERENCES projects(id) ON DELETE SET NULL,
  assigned_author UUID REFERENCES unified_users(id),
  assigned_editor UUID REFERENCES unified_users(id),
  stage workflow_stage_enum DEFAULT 'idea',
  due_date TIMESTAMP,
  priority priority_enum DEFAULT 'medium',
  tags TEXT[] DEFAULT '{}',
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TYPE workflow_stage_enum AS ENUM (
  'idea', 'planning', 'writing', 'review', 'editing', 
  'approval', 'scheduled', 'published', 'archived'
);

-- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¿ã‚¹ã‚¯é€£æºãƒ†ãƒ¼ãƒ–ãƒ«  
CREATE TABLE workflow_tasks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workflow_id UUID REFERENCES editorial_workflows(id) ON DELETE CASCADE,
  task_id UUID REFERENCES tasks(id) ON DELETE CASCADE,
  stage workflow_stage_enum NOT NULL,
  is_required BOOLEAN DEFAULT true,
  is_completed BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW()
);

-- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é€²æ—å±¥æ­´
CREATE TABLE workflow_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workflow_id UUID REFERENCES editorial_workflows(id) ON DELETE CASCADE,
  from_stage workflow_stage_enum,
  to_stage workflow_stage_enum NOT NULL,
  changed_by UUID REFERENCES unified_users(id),
  comment TEXT,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP DEFAULT NOW()
);
```

### ç·¨é›†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çµ±åˆã‚µãƒ¼ãƒ“ã‚¹
```typescript
export class EditorialWorkflowService {
  constructor(
    private wordpressAPI: WordPressAPI,
    private taskAPI: TaskAPI,
    private socketIO: Server
  ) {}

  // æ–°ã—ã„ç·¨é›†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä½œæˆ
  async createWorkflow(data: CreateWorkflowData): Promise<EditorialWorkflow> {
    const transaction = await db.transaction();
    
    try {
      // 1. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä½œæˆ
      const workflow = await EditorialWorkflow.create({
        title: data.title,
        description: data.description,
        projectId: data.projectId,
        assignedAuthor: data.assignedAuthor,
        assignedEditor: data.assignedEditor,
        stage: 'idea',
        dueDate: data.dueDate,
        priority: data.priority,
        tags: data.tags
      }, { transaction });

      // 2. WordPressã§ä¸‹æ›¸ãä½œæˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      let wpArticle = null;
      if (data.createDraft) {
        wpArticle = await this.wordpressAPI.createArticle({
          title: data.title,
          content: data.description || '',
          status: 'draft',
          categories: data.categories,
          tags: data.tags
        });

        await workflow.update({
          articleId: wpArticle.id,
          articleSlug: wpArticle.slug
        }, { transaction });
      }

      // 3. é–¢é€£ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•ç”Ÿæˆ
      const tasks = await this.createWorkflowTasks(workflow, transaction);

      await transaction.commit();

      // 4. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥
      this.socketIO.to(`project:${workflow.projectId}`).emit('workflow_created', {
        workflow,
        tasks,
        article: wpArticle
      });

      return workflow;
      
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }

  // ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’é€²è¡Œ
  async advanceStage(
    workflowId: string, 
    newStage: WorkflowStage,
    userId: string,
    comment?: string
  ): Promise<EditorialWorkflow> {
    const workflow = await EditorialWorkflow.findByPk(workflowId, {
      include: [{ model: WorkflowTask, include: [Task] }]
    });

    if (!workflow) {
      throw new Error('Workflow not found');
    }

    const transaction = await db.transaction();
    
    try {
      const oldStage = workflow.stage;

      // 1. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ›´æ–°
      await workflow.update({ stage: newStage }, { transaction });

      // 2. å±¥æ­´è¨˜éŒ²
      await WorkflowHistory.create({
        workflowId,
        fromStage: oldStage,
        toStage: newStage,
        changedBy: userId,
        comment
      }, { transaction });

      // 3. WordPressè¨˜äº‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åŒæœŸ
      if (workflow.articleId) {
        await this.syncArticleStatus(workflow.articleId, newStage);
      }

      // 4. é–¢é€£ã‚¿ã‚¹ã‚¯ã®è‡ªå‹•å®Œäº†/ä½œæˆ
      await this.handleStageTransition(workflow, oldStage, newStage, transaction);

      await transaction.commit();

      // 5. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥
      this.socketIO.to(`project:${workflow.projectId}`).emit('workflow_stage_changed', {
        workflowId,
        fromStage: oldStage,
        toStage: newStage,
        changedBy: userId,
        timestamp: new Date()
      });

      return workflow.reload();
      
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }

  // ã‚¹ãƒ†ãƒ¼ã‚¸é·ç§»æ™‚ã®è‡ªå‹•å‡¦ç†
  private async handleStageTransition(
    workflow: EditorialWorkflow,
    fromStage: WorkflowStage,
    toStage: WorkflowStage,
    transaction: Transaction
  ) {
    const stageTaskMap = {
      'writing': 'åŸ·ç­†',
      'review': 'ãƒ¬ãƒ“ãƒ¥ãƒ¼',
      'editing': 'ç·¨é›†',
      'approval': 'æ‰¿èª'
    };

    // å‰ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã®ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†
    if (stageTaskMap[fromStage as keyof typeof stageTaskMap]) {
      const taskKeyword = stageTaskMap[fromStage as keyof typeof stageTaskMap];
      const workflowTasks = await WorkflowTask.findAll({
        where: { workflowId: workflow.id, stage: fromStage },
        include: [{ model: Task, where: { title: { [Op.like]: `%${taskKeyword}%` } } }]
      });

      for (const workflowTask of workflowTasks) {
        await workflowTask.task.update({ status: 'completed' }, { transaction });
        await workflowTask.update({ isCompleted: true }, { transaction });
      }
    }

    // æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¸ã®ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
    if (stageTaskMap[toStage as keyof typeof stageTaskMap]) {
      const taskKeyword = stageTaskMap[toStage as keyof typeof stageTaskMap];
      const newTask = await this.taskAPI.createTask({
        title: `${taskKeyword}: ${workflow.title}`,
        description: `è¨˜äº‹ã€Œ${workflow.title}ã€ã®${taskKeyword}ã‚’è¡Œã†`,
        category: 'content',
        priority: workflow.priority,
        status: 'todo',
        projectId: workflow.projectId,
        assignedTo: toStage === 'writing' ? workflow.assignedAuthor : workflow.assignedEditor,
        dueDate: workflow.dueDate
      }, transaction);

      await WorkflowTask.create({
        workflowId: workflow.id,
        taskId: newTask.id,
        stage: toStage,
        isRequired: true
      }, { transaction });
    }
  }

  // WordPressè¨˜äº‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åŒæœŸ
  private async syncArticleStatus(articleId: number, stage: WorkflowStage) {
    const statusMap = {
      'idea': 'draft',
      'planning': 'draft',
      'writing': 'draft',
      'review': 'pending',
      'editing': 'pending',
      'approval': 'pending',
      'scheduled': 'future',
      'published': 'publish',
      'archived': 'private'
    };

    const wpStatus = statusMap[stage];
    if (wpStatus) {
      await this.wordpressAPI.updateArticle(articleId, {
        status: wpStatus,
        meta: {
          editorial_stage: stage,
          last_stage_update: new Date().toISOString()
        }
      });
    }
  }

  // ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç”¨ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•ç”Ÿæˆ
  private async createWorkflowTasks(
    workflow: EditorialWorkflow,
    transaction: Transaction
  ): Promise<Task[]> {
    const taskTemplates = [
      {
        title: `ä¼ç”»: ${workflow.title}`,
        description: 'è¨˜äº‹ã®ä¼ç”»ãƒ»æ§‹æˆã‚’æ¤œè¨ã™ã‚‹',
        stage: 'planning' as WorkflowStage,
        assignedTo: workflow.assignedAuthor,
        category: 'content' as const,
        estimatedHours: 2
      },
      {
        title: `åŸ·ç­†: ${workflow.title}`,
        description: 'è¨˜äº‹ã®åŸ·ç­†ã‚’è¡Œã†',
        stage: 'writing' as WorkflowStage,
        assignedTo: workflow.assignedAuthor,
        category: 'content' as const,
        estimatedHours: 6
      },
      {
        title: `ãƒ¬ãƒ“ãƒ¥ãƒ¼: ${workflow.title}`,
        description: 'è¨˜äº‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æ ¡æ­£ã‚’è¡Œã†',
        stage: 'review' as WorkflowStage,
        assignedTo: workflow.assignedEditor,
        category: 'content' as const,
        estimatedHours: 2
      }
    ];

    const tasks: Task[] = [];
    
    for (const template of taskTemplates) {
      const task = await this.taskAPI.createTask({
        title: template.title,
        description: template.description,
        category: template.category,
        priority: workflow.priority,
        status: template.stage === 'planning' ? 'todo' : 'blocked',
        projectId: workflow.projectId,
        assignedTo: template.assignedTo,
        dueDate: workflow.dueDate,
        estimatedHours: template.estimatedHours,
        tags: [...workflow.tags, 'editorial']
      }, transaction);

      await WorkflowTask.create({
        workflowId: workflow.id,
        taskId: task.id,
        stage: template.stage,
        isRequired: true
      }, { transaction });

      tasks.push(task);
    }

    return tasks;
  }
}
```

---

# Headless WordPress CMS ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### WordPressè¨­å®š

#### 1. WordPress ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¨­å®š
- **ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°**: WordPress.com Business / WP Engine / ç‹¬è‡ªã‚µãƒ¼ãƒãƒ¼
- **ãƒ‰ãƒ¡ã‚¤ãƒ³**: cms.coral-news.comï¼ˆæ¨å¥¨ï¼‰
- **SSL**: å¿…é ˆ
- **PHP**: 8.1ä»¥ä¸Šæ¨å¥¨

#### 2. å¿…è¦ãƒ—ãƒ©ã‚°ã‚¤ãƒ³
```
- WPGraphQLï¼ˆGraphQL APIï¼‰
- Advanced Custom Fieldsï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰
- Yoast SEOï¼ˆSEOæœ€é©åŒ–ï¼‰
- JWT Authenticationï¼ˆèªè¨¼ï¼‰
- CORS Headersï¼ˆCORSè¨­å®šï¼‰
- WP REST API Cacheï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
```

#### 3. ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—
```php
// functions.php
register_post_type('article', [
    'public' => true,
    'show_in_rest' => true,
    'show_in_graphql' => true,
    'graphql_single_name' => 'article',
    'graphql_plural_name' => 'articles',
    'supports' => ['title', 'editor', 'thumbnail', 'excerpt'],
    'taxonomies' => ['category', 'post_tag']
]);
```

### ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚­ãƒ¼ãƒ

#### è¨˜äº‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
```typescript
interface WordPressArticle {
  id: number;
  slug: string;
  title: {
    rendered: string;
  };
  content: {
    rendered: string;
  };
  excerpt: {
    rendered: string;
  };
  date: string;
  modified: string;
  featured_media: number;
  categories: number[];
  tags: number[];
  acf: {
    featured_image_alt?: string;
    article_subtitle?: string;
    reading_time?: number;
    author_bio?: string;
    related_articles?: number[];
  };
  _embedded: {
    'wp:featuredmedia': Array<{
      source_url: string;
      alt_text: string;
      media_details: {
        sizes: {
          thumbnail: { source_url: string };
          medium: { source_url: string };
          large: { source_url: string };
          full: { source_url: string };
        };
      };
    }>;
    'wp:term': Array<Array<{
      id: number;
      name: string;
      slug: string;
    }>>;
  };
}
```

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

### 1. APIè¨­å®š

#### ç’°å¢ƒå¤‰æ•° (.env.local)
```env
VITE_WP_API_URL=https://cms.coral-news.com/wp-json/wp/v2
VITE_WP_GRAPHQL_URL=https://cms.coral-news.com/graphql
VITE_WP_AUTH_TOKEN=your_jwt_token
```

#### APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (src/lib/wordpress.ts)
```typescript
import axios from 'axios';

const API_URL = import.meta.env.VITE_WP_API_URL;

export const wpApi = axios.create({
  baseURL: API_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// APIé–¢æ•°
export const wordPressAPI = {
  // è¨˜äº‹ä¸€è¦§å–å¾—
  getArticles: async (params?: {
    page?: number;
    per_page?: number;
    categories?: string;
    tags?: string;
    search?: string;
  }) => {
    const { data } = await wpApi.get('/articles', {
      params: {
        ...params,
        _embed: true, // ãƒ¡ãƒ‡ã‚£ã‚¢ã¨ã‚¿ã‚¯ã‚½ãƒãƒŸãƒ¼æƒ…å ±ã‚’å«ã‚ã‚‹
      },
    });
    return data;
  },

  // è¨˜äº‹è©³ç´°å–å¾—
  getArticle: async (slug: string) => {
    const { data } = await wpApi.get('/articles', {
      params: {
        slug,
        _embed: true,
      },
    });
    return data[0];
  },

  // ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§
  getCategories: async () => {
    const { data } = await wpApi.get('/categories');
    return data;
  },

  // ã‚¿ã‚°ä¸€è¦§
  getTags: async () => {
    const { data } = await wpApi.get('/tags');
    return data;
  },
};
```

### 2. React Queryçµ±åˆ

#### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è¿½åŠ 
```bash
npm install @tanstack/react-query @tanstack/react-query-devtools
```

#### Query Clientè¨­å®š (src/lib/queryClient.ts)
```typescript
import { QueryClient } from '@tanstack/react-query';

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 60 * 5, // 5åˆ†
      gcTime: 1000 * 60 * 30, // 30åˆ†ï¼ˆæ—§cacheTimeï¼‰
      retry: 1,
      refetchOnWindowFocus: false,
    },
  },
});
```

### 3. ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ (src/hooks/useWordPress.ts)

```typescript
import { useQuery } from '@tanstack/react-query';
import { wordPressAPI } from '@/lib/wordpress';

export function useArticles(params?: {
  page?: number;
  per_page?: number;
  categories?: string;
  tags?: string;
}) {
  return useQuery({
    queryKey: ['articles', params],
    queryFn: () => wordPressAPI.getArticles(params),
  });
}

export function useArticle(slug: string) {
  return useQuery({
    queryKey: ['article', slug],
    queryFn: () => wordPressAPI.getArticle(slug),
    enabled: !!slug,
  });
}

export function useCategories() {
  return useQuery({
    queryKey: ['categories'],
    queryFn: () => wordPressAPI.getCategories(),
  });
}
```

### 4. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ›´æ–°

#### ArticleCard ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
```typescript
import { WordPressArticle } from '@/types/wordpress';

interface ArticleCardProps {
  article: WordPressArticle;
}

export const ArticleCard = ({ article }: ArticleCardProps) => {
  const featuredImage = article._embedded?.['wp:featuredmedia']?.[0];
  const categories = article._embedded?.['wp:term']?.[0] || [];
  
  return (
    <FeaturedArticle>
      <ArticleBackground
        style={{
          backgroundImage: `url(${featuredImage?.source_url})`,
        }}
      />
      <ArticleContent>
        <ArticleTag>
          {categories[0]?.name || 'ãƒ‹ãƒ¥ãƒ¼ã‚¹'}
        </ArticleTag>
        <ArticleTitle>
          {article.title.rendered}
        </ArticleTitle>
        <ArticleMeta>
          <span>{new Date(article.date).toLocaleDateString('ja-JP')}</span>
        </ArticleMeta>
      </ArticleContent>
    </FeaturedArticle>
  );
};
```

## ãƒ‡ãƒ¼ã‚¿ç§»è¡Œè¨ˆç”»

### 1. ãƒ•ã‚§ãƒ¼ã‚º1: WordPressç’°å¢ƒæ§‹ç¯‰ï¼ˆ1é€±é–“ï¼‰
- WordPressã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- å¿…è¦ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨è¨­å®š
- ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—ã¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä½œæˆ
- REST API/GraphQLã®è¨­å®šã¨ãƒ†ã‚¹ãƒˆ

### 2. ãƒ•ã‚§ãƒ¼ã‚º2: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆï¼ˆ1-2é€±é–“ï¼‰
- React Query ã®çµ±åˆ
- WordPress API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…
- æ—¢å­˜ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®WordPressãƒ‡ãƒ¼ã‚¿å¯¾å¿œ
- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å‹•çš„åŒ–

### 3. ãƒ•ã‚§ãƒ¼ã‚º3: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç§»è¡Œï¼ˆ1é€±é–“ï¼‰
- æ—¢å­˜è¨˜äº‹ã®WordPressã¸ã®ç§»è¡Œ
- ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®WordPressãƒ¡ãƒ‡ã‚£ã‚¢ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¸ç§»è¡Œ
- ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨ã‚¿ã‚°ã®è¨­å®š
- SEOè¨­å®šã®ç§»è¡Œ

### 4. ãƒ•ã‚§ãƒ¼ã‚º4: æœ€é©åŒ–ã¨ãƒ†ã‚¹ãƒˆï¼ˆ1é€±é–“ï¼‰
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®å®Ÿè£…
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
- ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã§ã®æ¤œè¨¼

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
```typescript
// ISRç›¸å½“ã®å®Ÿè£…
export async function generateStaticParams() {
  const articles = await wordPressAPI.getArticles({ per_page: 100 });
  return articles.map((article: WordPressArticle) => ({
    slug: article.slug,
  }));
}
```

### 2. ç”»åƒæœ€é©åŒ–
- WordPressã®ç”»åƒæœ€é©åŒ–ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ï¼ˆSmush, Optimoleï¼‰
- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ç”»åƒã®è‡ªå‹•ç”Ÿæˆ
- WebPå¯¾å¿œ

### 3. CDNã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥
```typescript
// Vercel Edge Functionsæ´»ç”¨
export const config = {
  runtime: 'edge',
};

export default async function handler(req: Request) {
  const response = await wordPressAPI.getArticles();
  
  return new Response(JSON.stringify(response), {
    headers: {
      'Cache-Control': 'public, s-maxage=60, stale-while-revalidate=300',
      'Content-Type': 'application/json',
    },
  });
}
```

## SEOå¯¾ç­–

### 1. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†
```typescript
// WordPressã‹ã‚‰SEOãƒ‡ãƒ¼ã‚¿å–å¾—
export const generateMetadata = async ({ params }: { params: { slug: string } }) => {
  const article = await wordPressAPI.getArticle(params.slug);
  
  return {
    title: article.title.rendered,
    description: article.excerpt.rendered.replace(/<[^>]*>/g, ''),
    openGraph: {
      title: article.title.rendered,
      description: article.excerpt.rendered.replace(/<[^>]*>/g, ''),
      images: [article._embedded?.['wp:featuredmedia']?.[0]?.source_url],
    },
  };
};
```

### 2. ã‚µã‚¤ãƒˆãƒãƒƒãƒ—è‡ªå‹•ç”Ÿæˆ
- WordPress XML Sitemaps ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ´»ç”¨
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®ã‚µã‚¤ãƒˆãƒãƒƒãƒ—çµ±åˆ

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

### 1. WordPress ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®å¤‰æ›´
- 2FAèªè¨¼ã®æœ‰åŠ¹åŒ–
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ï¼ˆWordfenceï¼‰
- å®šæœŸçš„ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

### 2. API ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
```php
// JWTèªè¨¼è¨­å®š
add_filter('jwt_auth_whitelist', function($whitelist) {
    $whitelist[] = '/wp-json/wp/v2/articles';
    return $whitelist;
});
```

## é‹ç”¨ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### 1. è‡ªå‹•åŒ–
- GitHub Actions ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤è‡ªå‹•åŒ–
- WordPressãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®è‡ªå‹•æ›´æ–°
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–

### 2. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥
- æ¯æ—¥ã®è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- AWS S3 / Google Cloud Storageé€£æº
- å¾©æ—§æ‰‹é †ã®æ–‡æ›¸åŒ–

### 3. ç›£è¦–
- Uptimeç›£è¦–ï¼ˆUptimeRobotï¼‰
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ï¼ˆNew Relicï¼‰
- ã‚¨ãƒ©ãƒ¼ç›£è¦–ï¼ˆSentryï¼‰

## å¿…è¦ãƒªã‚½ãƒ¼ã‚¹

### æŠ€è¡“çš„è¦ä»¶
- WordPress ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°: $20-100/æœˆ
- CDN (Cloudflare): ç„¡æ–™-$20/æœˆ
- ç›£è¦–ãƒ„ãƒ¼ãƒ«: $10-50/æœˆ

### é–‹ç™ºå·¥æ•°
- ç·å·¥æ•°: 4-5é€±é–“ï¼ˆ1äººï¼‰
- WordPressæ§‹ç¯‰: 1é€±é–“
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…: 1-2é€±é–“
- ç§»è¡Œä½œæ¥­: 1é€±é–“
- ãƒ†ã‚¹ãƒˆãƒ»æœ€é©åŒ–: 1é€±é–“

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. WordPress ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ç’°å¢ƒã®æ±ºå®š
2. ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šï¼ˆcms.coral-news.comï¼‰
3. WordPress ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®æ¤œè¨¼
4. ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—é–‹ç™ºã®é–‹å§‹

ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã‚ˆã‚Šã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç®¡ç†ã®åŠ¹ç‡åŒ–ã¨ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã®å‘ä¸Šã‚’å®Ÿç¾ã§ãã¾ã™ã€‚

---

# çµ±åˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¨­è¨ˆ

## çµ±åˆçŠ¶æ…‹ç®¡ç†ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹è¨­è¨ˆ
```typescript
// çµ±åˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
interface UnifiedAppState {
  // èªè¨¼ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹
  auth: {
    user: UnifiedUser | null;
    isAuthenticated: boolean;
    permissions: {
      cms: string[];
      projects: string[];
    };
    loading: boolean;
  };

  // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç®¡ç†çŠ¶æ…‹
  content: {
    articles: Article[];
    categories: Category[];
    media: MediaItem[];
    workflows: EditorialWorkflow[];
    loading: {
      articles: boolean;
      workflows: boolean;
    };
    filters: {
      category?: string;
      status?: string;
      author?: string;
    };
  };

  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†çŠ¶æ…‹
  projects: {
    projects: Project[];
    currentProject?: Project;
    tasks: Task[];
    boards: { [projectId: string]: KanbanBoard };
    loading: {
      projects: boolean;
      tasks: boolean;
      boards: boolean;
    };
    filters: TaskFilter;
  };

  // UIçŠ¶æ…‹
  ui: {
    theme: 'light' | 'dark';
    sidebarCollapsed: boolean;
    activeView: 'dashboard' | 'content' | 'projects' | 'workflows';
    modals: {
      createTask: boolean;
      createWorkflow: boolean;
      createArticle: boolean;
    };
    notifications: Notification[];
  };

  // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çŠ¶æ…‹
  realtime: {
    connected: boolean;
    joinedRooms: string[];
    lastUpdate: Date;
  };
}
```

### çµ±åˆContextãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼
```typescript
// çµ±åˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼
export const UnifiedAppProvider: React.FC<{ children: React.ReactNode }> = ({ 
  children 
}) => {
  const [state, dispatch] = useReducer(unifiedReducer, initialState);
  const queryClient = useQueryClient();
  const [socket, setSocket] = useState<Socket | null>(null);

  // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
  useEffect(() => {
    const token = localStorage.getItem('auth_token');
    if (token && !state.auth.isAuthenticated) {
      dispatch({ type: 'AUTH_RESTORE_SESSION', payload: { token } });
    }
  }, []);

  // Socket.ioæ¥ç¶šç®¡ç†
  useEffect(() => {
    if (state.auth.isAuthenticated && !socket) {
      const newSocket = io(API_BASE_URL, {
        auth: { token: localStorage.getItem('auth_token') }
      });

      // æ¥ç¶šã‚¤ãƒ™ãƒ³ãƒˆ
      newSocket.on('connect', () => {
        dispatch({ type: 'REALTIME_CONNECTED' });
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒ ã«è‡ªå‹•å‚åŠ 
        if (state.projects.currentProject) {
          newSocket.emit('join-project', state.projects.currentProject.id);
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¹ã‚¯ãƒ«ãƒ¼ãƒ ã«å‚åŠ 
        newSocket.emit('join-user-tasks');
      });

      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      newSocket.on('task_updated', (data) => {
        dispatch({ type: 'TASK_UPDATED', payload: data.task });
        queryClient.setQueryData(['tasks'], (old: Task[]) => 
          old?.map(task => task.id === data.task.id ? data.task : task)
        );
        
        // é€šçŸ¥è¡¨ç¤º
        if (data.task.assignedTo === state.auth.user?.id) {
          dispatch({
            type: 'ADD_NOTIFICATION',
            payload: {
              id: Date.now().toString(),
              type: 'info',
              title: 'ã‚¿ã‚¹ã‚¯æ›´æ–°',
              message: `ã€Œ${data.task.title}ã€ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ`,
              timestamp: new Date()
            }
          });
        }
      });

      newSocket.on('workflow_stage_changed', (data) => {
        dispatch({ type: 'WORKFLOW_STAGE_CHANGED', payload: data });
        
        // ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¸€è¦§ã‚’æ›´æ–°
        queryClient.invalidateQueries(['workflows']);
      });

      newSocket.on('article_updated', (data) => {
        dispatch({ type: 'ARTICLE_UPDATED', payload: data.article });
        queryClient.setQueryData(['articles'], (old: Article[]) =>
          old?.map(article => article.id === data.article.id ? data.article : article)
        );
      });

      setSocket(newSocket);
    }

    return () => {
      if (socket) {
        socket.disconnect();
        setSocket(null);
        dispatch({ type: 'REALTIME_DISCONNECTED' });
      }
    };
  }, [state.auth.isAuthenticated]);

  const contextValue = {
    state,
    dispatch,
    socket,
    
    // ä¾¿åˆ©ãªãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    helpers: {
      hasPermission: (permission: string) => {
        const [service] = permission.split(':');
        return state.auth.permissions[service as keyof typeof state.auth.permissions]?.includes(permission) ?? false;
      },
      
      joinProject: (projectId: string) => {
        socket?.emit('join-project', projectId);
        dispatch({ type: 'JOIN_PROJECT_ROOM', payload: projectId });
      },
      
      leaveProject: (projectId: string) => {
        socket?.emit('leave-project', projectId);
        dispatch({ type: 'LEAVE_PROJECT_ROOM', payload: projectId });
      },

      showNotification: (notification: Omit<Notification, 'id' | 'timestamp'>) => {
        dispatch({
          type: 'ADD_NOTIFICATION',
          payload: {
            ...notification,
            id: Date.now().toString(),
            timestamp: new Date()
          }
        });
      }
    }
  };

  return (
    <UnifiedAppContext.Provider value={contextValue}>
      {children}
    </UnifiedAppContext.Provider>
  );
};
```

## çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
```typescript
// çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
const UnifiedDashboard: React.FC = () => {
  const { state, helpers } = useUnifiedApp();
  const { user, isAuthenticated } = state.auth;
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚¹ã‚¯ã¨æ‹…å½“ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å–å¾—
  const { data: userTasks } = useQuery({
    queryKey: ['user-tasks', user?.id],
    queryFn: () => taskAPI.getUserTasks(user!.id),
    enabled: !!user
  });

  const { data: userWorkflows } = useQuery({
    queryKey: ['user-workflows', user?.id],
    queryFn: () => editorialAPI.getUserWorkflows(user!.id),
    enabled: !!user
  });

  const { data: recentArticles } = useQuery({
    queryKey: ['recent-articles'],
    queryFn: () => contentAPI.getRecentArticles(5),
    staleTime: 5 * 60 * 1000 // 5åˆ†
  });

  if (!isAuthenticated) {
    return <LoginForm />;
  }

  return (
    <DashboardLayout>
      <DashboardHeader>
        <WelcomeSection user={user} />
        <QuickActions />
      </DashboardHeader>

      <DashboardGrid>
        {/* ã‚¿ã‚¹ã‚¯æ¦‚è¦ */}
        <DashboardCard title="ğŸ“‹ ãƒã‚¤ã‚¿ã‚¹ã‚¯" colSpan={1}>
          <TaskSummaryWidget 
            tasks={userTasks} 
            onViewAll={() => helpers.dispatch({ type: 'SET_ACTIVE_VIEW', payload: 'projects' })}
          />
        </DashboardCard>

        {/* ç·¨é›†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ */}
        <DashboardCard title="âœï¸ æ‹…å½“è¨˜äº‹" colSpan={1}>
          <WorkflowSummaryWidget 
            workflows={userWorkflows}
            onViewAll={() => helpers.dispatch({ type: 'SET_ACTIVE_VIEW', payload: 'workflows' })}
          />
        </DashboardCard>

        {/* æœ€è¿‘ã®è¨˜äº‹ */}
        <DashboardCard title="ğŸ“° æœ€æ–°è¨˜äº‹" colSpan={2}>
          <ArticleSummaryWidget 
            articles={recentArticles}
            onViewAll={() => helpers.dispatch({ type: 'SET_ACTIVE_VIEW', payload: 'content' })}
          />
        </DashboardCard>

        {/* ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ•ã‚£ãƒ¼ãƒ‰ */}
        <DashboardCard title="ğŸ”” æœ€æ–°ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£" colSpan={1}>
          <ActivityFeedWidget />
        </DashboardCard>

        {/* çµ±è¨ˆæƒ…å ± */}
        <DashboardCard title="ğŸ“Š çµ±è¨ˆ" colSpan={1}>
          <DashboardStatsWidget />
        </DashboardCard>
      </DashboardGrid>
    </DashboardLayout>
  );
};

// ã‚¿ã‚¹ã‚¯æ¦‚è¦ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
const TaskSummaryWidget: React.FC<{
  tasks?: Task[];
  onViewAll: () => void;
}> = ({ tasks = [], onViewAll }) => {
  const taskStats = useMemo(() => {
    return {
      total: tasks.length,
      todo: tasks.filter(t => t.status === 'todo').length,
      inProgress: tasks.filter(t => t.status === 'in_progress').length,
      overdue: tasks.filter(t => 
        t.dueDate && new Date(t.dueDate) < new Date() && t.status !== 'completed'
      ).length
    };
  }, [tasks]);

  const urgentTasks = useMemo(() => 
    tasks
      .filter(t => t.priority === 'urgent' && t.status !== 'completed')
      .slice(0, 3),
    [tasks]
  );

  return (
    <WidgetContainer>
      <StatsGrid>
        <StatItem>
          <StatValue color="#3b82f6">{taskStats.total}</StatValue>
          <StatLabel>ç·ã‚¿ã‚¹ã‚¯</StatLabel>
        </StatItem>
        <StatItem>
          <StatValue color="#f59e0b">{taskStats.inProgress}</StatValue>
          <StatLabel>é€²è¡Œä¸­</StatLabel>
        </StatItem>
        <StatItem>
          <StatValue color="#ef4444">{taskStats.overdue}</StatValue>
          <StatLabel>æœŸé™åˆ‡ã‚Œ</StatLabel>
        </StatItem>
      </StatsGrid>

      {urgentTasks.length > 0 && (
        <UrgentTasksList>
          <SectionTitle>ğŸš¨ ç·Šæ€¥ã‚¿ã‚¹ã‚¯</SectionTitle>
          {urgentTasks.map(task => (
            <TaskItem key={task.id}>
              <TaskTitle>{task.title}</TaskTitle>
              <TaskDueDate overdue={task.dueDate && new Date(task.dueDate) < new Date()}>
                {task.dueDate && format(new Date(task.dueDate), 'MM/dd')}
              </TaskDueDate>
            </TaskItem>
          ))}
        </UrgentTasksList>
      )}

      <ViewAllButton onClick={onViewAll}>
        ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º â†’
      </ViewAllButton>
    </WidgetContainer>
  );
};

// ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ¦‚è¦ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
const WorkflowSummaryWidget: React.FC<{
  workflows?: EditorialWorkflow[];
  onViewAll: () => void;
}> = ({ workflows = [], onViewAll }) => {
  const activeWorkflows = useMemo(() => 
    workflows.filter(w => !['published', 'archived'].includes(w.stage)),
    [workflows]
  );

  const workflowsByStage = useMemo(() => {
    const stages = ['writing', 'review', 'editing', 'approval'];
    return stages.map(stage => ({
      stage,
      count: activeWorkflows.filter(w => w.stage === stage).length,
      label: {
        writing: 'åŸ·ç­†ä¸­',
        review: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­',
        editing: 'ç·¨é›†ä¸­',
        approval: 'æ‰¿èªå¾…ã¡'
      }[stage]
    }));
  }, [activeWorkflows]);

  return (
    <WidgetContainer>
      <StatsGrid columns={2}>
        {workflowsByStage.map(({ stage, count, label }) => (
          <StatItem key={stage}>
            <StatValue color={getStageColor(stage)}>{count}</StatValue>
            <StatLabel>{label}</StatLabel>
          </StatItem>
        ))}
      </StatsGrid>

      {activeWorkflows.slice(0, 3).map(workflow => (
        <WorkflowItem key={workflow.id}>
          <WorkflowTitle>{workflow.title}</WorkflowTitle>
          <WorkflowStage stage={workflow.stage}>
            {getStageLabel(workflow.stage)}
          </WorkflowStage>
        </WorkflowItem>
      ))}

      <ViewAllButton onClick={onViewAll}>
        ç·¨é›†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’è¡¨ç¤º â†’
      </ViewAllButton>
    </WidgetContainer>
  );
};
```

## ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆ

### çµ±åˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
```typescript
// çµ±åˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
const UnifiedNavigation: React.FC = () => {
  const { state, helpers } = useUnifiedApp();
  const { activeView } = state.ui;
  const { user } = state.auth;
  
  const navigationItems = [
    {
      id: 'dashboard',
      label: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',
      icon: 'ğŸ ',
      path: '/',
      requiresAuth: true
    },
    {
      id: 'content',
      label: 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„',
      icon: 'ğŸ“',
      path: '/content',
      requiresAuth: true,
      permission: 'cms:read',
      subItems: [
        { id: 'articles', label: 'è¨˜äº‹ç®¡ç†', path: '/content/articles' },
        { id: 'media', label: 'ãƒ¡ãƒ‡ã‚£ã‚¢', path: '/content/media' },
        { id: 'categories', label: 'ã‚«ãƒ†ã‚´ãƒª', path: '/content/categories' }
      ]
    },
    {
      id: 'workflows',
      label: 'ç·¨é›†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼',
      icon: 'âœï¸',
      path: '/workflows',
      requiresAuth: true,
      permission: 'cms:write'
    },
    {
      id: 'projects',
      label: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',
      icon: 'ğŸ“Š',
      path: '/projects',
      requiresAuth: true,
      permission: 'projects:read',
      subItems: [
        { id: 'project-list', label: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§', path: '/projects' },
        { id: 'my-tasks', label: 'ãƒã‚¤ã‚¿ã‚¹ã‚¯', path: '/projects/my-tasks' },
        { id: 'team', label: 'ãƒãƒ¼ãƒ ', path: '/projects/team' }
      ]
    }
  ];

  const visibleItems = navigationItems.filter(item => {
    if (item.requiresAuth && !user) return false;
    if (item.permission && !helpers.hasPermission(item.permission)) return false;
    return true;
  });

  return (
    <NavigationContainer collapsed={state.ui.sidebarCollapsed}>
      <NavigationHeader>
        <Logo collapsed={state.ui.sidebarCollapsed}>
          <span>ğŸŒŠ CORAL</span>
        </Logo>
        <CollapseButton
          onClick={() => helpers.dispatch({ type: 'TOGGLE_SIDEBAR' })}
        >
          {state.ui.sidebarCollapsed ? 'â†’' : 'â†'}
        </CollapseButton>
      </NavigationHeader>

      <NavigationBody>
        {visibleItems.map(item => (
          <NavigationItem
            key={item.id}
            item={item}
            isActive={activeView === item.id}
            collapsed={state.ui.sidebarCollapsed}
            onClick={() => helpers.dispatch({ 
              type: 'SET_ACTIVE_VIEW', 
              payload: item.id as any 
            })}
          />
        ))}
      </NavigationBody>

      <NavigationFooter>
        <UserProfile user={user} collapsed={state.ui.sidebarCollapsed} />
        <ThemeToggle />
      </NavigationFooter>
    </NavigationContainer>
  );
};

const NavigationItem: React.FC<{
  item: NavigationItemType;
  isActive: boolean;
  collapsed: boolean;
  onClick: () => void;
}> = ({ item, isActive, collapsed, onClick }) => {
  const [expanded, setExpanded] = useState(false);

  return (
    <NavigationItemContainer>
      <NavigationLink
        isActive={isActive}
        collapsed={collapsed}
        onClick={onClick}
      >
        <NavigationIcon>{item.icon}</NavigationIcon>
        {!collapsed && (
          <>
            <NavigationLabel>{item.label}</NavigationLabel>
            {item.subItems && (
              <ExpandIcon
                expanded={expanded}
                onClick={(e) => {
                  e.stopPropagation();
                  setExpanded(!expanded);
                }}
              >
                {expanded ? 'â–¼' : 'â–¶'}
              </ExpandIcon>
            )}
          </>
        )}
      </NavigationLink>

      {!collapsed && item.subItems && expanded && (
        <SubNavigationList>
          {item.subItems.map(subItem => (
            <SubNavigationItem key={subItem.id}>
              <Link to={subItem.path}>{subItem.label}</Link>
            </SubNavigationItem>
          ))}
        </SubNavigationList>
      )}
    </NavigationItemContainer>
  );
};
```

---

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ è©³ç´°è¨­è¨ˆ

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±åˆè¨­è¨ˆ

### çµ±åˆERD
```
unified_users (1) â”€â”€â”€ (N) user_permissions
     â”‚                      â”‚
     â””â”€â”€ (N) project_members â”€â”€ (1) projects (1) â”€â”€ (N) editorial_workflows
     â”‚            â”‚                    â”‚                      â”‚
     â””â”€â”€ (N) tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (1)                   â”‚
          â”‚                                                   â”‚
          â””â”€â”€ (N) workflow_tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â””â”€â”€ (N) task_events, task_comments, task_time_entries
```

## è¦ä»¶

### æ©Ÿèƒ½è¦ä»¶
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥ã®ã‚«ãƒ³ãƒãƒ³ãƒœãƒ¼ãƒ‰ç®¡ç†
- å€‹äººã‚¿ã‚¹ã‚¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çŠ¶æ…‹åŒæœŸ
- ã‚¿ã‚¹ã‚¯ã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã«ã‚ˆã‚‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´
- ã‚¢ã‚µã‚¤ãƒ³ãƒ»å„ªå…ˆåº¦ãƒ»æœŸé™ç®¡ç†
- å¤‰æ›´å±¥æ­´ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½
- é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 

### éæ©Ÿèƒ½è¦ä»¶
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ < 100msï¼‰
- ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ï¼ˆåŒæ™‚æ¥ç¶š1000+ï¼‰
- å¯ç”¨æ€§ï¼ˆ99.9%ä»¥ä¸Šï¼‰
- ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ä¿è¨¼

## æ¨å¥¨æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
- **Node.js + Express** - APIã‚µãƒ¼ãƒãƒ¼
- **PostgreSQL** - ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- **Redis** - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- **Socket.io** - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡
- **Bull Queue** - ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†

### ã‚¤ãƒ³ãƒ•ãƒ©
- **Docker + Docker Compose** - é–‹ç™ºç’°å¢ƒ
- **AWS ECS** ã¾ãŸã¯ **Railway** - æœ¬ç•ªç’°å¢ƒ
- **AWS RDS** ã¾ãŸã¯ **Supabase** - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- **AWS ElastiCache** - Redis

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### ERDæ¦‚è¦
```
Users (1) â”€â”€â”€ (N) ProjectMembers (N) â”€â”€â”€ (1) Projects
                         â”‚                      â”‚
                         â”‚                      â”‚
Users (1) â”€â”€â”€ (N) Tasks (N) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (1) Projects
  â”‚             â”‚
  â”‚             â”‚
  â””â”€â”€â”€â”€ (N) TaskComments
        (N) TaskEvents
        (N) TaskTimeEntries
```

### ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©

#### 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(255) NOT NULL,
  avatar_url VARCHAR(500),
  role user_role_enum DEFAULT 'member',
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TYPE user_role_enum AS ENUM ('admin', 'manager', 'member', 'viewer');
```

#### 2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†
```sql
CREATE TABLE projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  description TEXT,
  color VARCHAR(7) DEFAULT '#9333ea',
  icon VARCHAR(50) DEFAULT 'ğŸ“‹',
  status project_status_enum DEFAULT 'active',
  start_date DATE,
  end_date DATE,
  progress INTEGER DEFAULT 0 CHECK (progress >= 0 AND progress <= 100),
  created_by UUID REFERENCES users(id) ON DELETE SET NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TYPE project_status_enum AS ENUM ('active', 'completed', 'on_hold', 'cancelled');

CREATE TABLE project_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role project_member_role_enum DEFAULT 'member',
  joined_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(project_id, user_id)
);

CREATE TYPE project_member_role_enum AS ENUM ('owner', 'admin', 'member', 'viewer');
```

#### 3. ã‚¿ã‚¹ã‚¯ç®¡ç†ï¼ˆä¸­å¿ƒã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼‰
```sql
CREATE TABLE tasks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(500) NOT NULL,
  description TEXT,
  priority task_priority_enum DEFAULT 'medium',
  status task_status_enum DEFAULT 'todo',
  category task_category_enum DEFAULT 'other',
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  assigned_to UUID REFERENCES users(id) ON DELETE SET NULL,
  created_by UUID REFERENCES users(id) ON DELETE SET NULL,
  due_date TIMESTAMP,
  estimated_hours INTEGER CHECK (estimated_hours >= 0),
  actual_hours INTEGER DEFAULT 0 CHECK (actual_hours >= 0),
  tags TEXT[] DEFAULT '{}',
  position INTEGER DEFAULT 0, -- ã‚«ãƒ³ãƒãƒ³ãƒœãƒ¼ãƒ‰å†…ã®é †åº
  is_archived BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  
  -- æ¤œç´¢ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
  CONSTRAINT valid_hours CHECK (actual_hours <= (estimated_hours * 2)) -- å®Ÿç¸¾å·¥æ•°ã¯äºˆå®šã®2å€ã¾ã§
);

CREATE TYPE task_priority_enum AS ENUM ('low', 'medium', 'high', 'urgent');
CREATE TYPE task_status_enum AS ENUM ('todo', 'in_progress', 'review', 'completed', 'blocked', 'cancelled');
CREATE TYPE task_category_enum AS ENUM ('development', 'design', 'marketing', 'content', 'research', 'meeting', 'other');

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­å®š
CREATE INDEX idx_tasks_project_id ON tasks(project_id);
CREATE INDEX idx_tasks_assigned_to ON tasks(assigned_to);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_priority ON tasks(priority);
CREATE INDEX idx_tasks_due_date ON tasks(due_date) WHERE due_date IS NOT NULL;
CREATE INDEX idx_tasks_created_at ON tasks(created_at);
CREATE INDEX idx_tasks_position_status ON tasks(project_id, status, position); -- ã‚«ãƒ³ãƒãƒ³ãƒœãƒ¼ãƒ‰ç”¨
```

#### 4. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸç”¨ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°
```sql
CREATE TABLE task_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id UUID REFERENCES tasks(id) ON DELETE CASCADE,
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  event_type task_event_type_enum NOT NULL,
  old_data JSONB,
  new_data JSONB NOT NULL,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TYPE task_event_type_enum AS ENUM (
  'created', 'updated', 'status_changed', 'assigned', 'unassigned', 
  'priority_changed', 'due_date_changed', 'completed', 'archived', 'deleted'
);

-- ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_task_events_task_id ON task_events(task_id);
CREATE INDEX idx_task_events_project_id ON task_events(project_id);
CREATE INDEX idx_task_events_created_at ON task_events(created_at DESC);
CREATE INDEX idx_task_events_type ON task_events(event_type);
```

#### 5. ã‚³ãƒ¡ãƒ³ãƒˆãƒ»æ™‚é–“ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
```sql
CREATE TABLE task_comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id UUID REFERENCES tasks(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  content TEXT NOT NULL,
  mentions UUID[] DEFAULT '{}', -- ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE task_time_entries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id UUID REFERENCES tasks(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  description TEXT,
  duration_minutes INTEGER NOT NULL CHECK (duration_minutes > 0),
  started_at TIMESTAMP NOT NULL,
  ended_at TIMESTAMP,
  is_running BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT NOW()
);

-- åŒä¸€ã‚¿ã‚¹ã‚¯ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å®Ÿè¡Œä¸­ã®ã‚¨ãƒ³ãƒˆãƒªã¯1ã¤ã¾ã§
CREATE UNIQUE INDEX idx_running_time_entries ON task_time_entries(task_id, user_id) 
WHERE is_running = true;
```

## APIè¨­è¨ˆ

### REST APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

#### èªè¨¼ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
```typescript
POST   /api/auth/login
POST   /api/auth/logout
GET    /api/auth/me
PUT    /api/auth/profile
```

#### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†
```typescript
GET    /api/projects                    // å‚åŠ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
POST   /api/projects                    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
GET    /api/projects/:id                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°
PUT    /api/projects/:id                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°
DELETE /api/projects/:id                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤
GET    /api/projects/:id/members        // ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§
POST   /api/projects/:id/members        // ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ 
DELETE /api/projects/:id/members/:userId // ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤
GET    /api/projects/:id/board          // ã‚«ãƒ³ãƒãƒ³ãƒœãƒ¼ãƒ‰
```

#### ã‚¿ã‚¹ã‚¯ç®¡ç†
```typescript
GET    /api/tasks                       // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¯¾å¿œ
POST   /api/tasks                       // ã‚¿ã‚¹ã‚¯ä½œæˆ
GET    /api/tasks/:id                   // ã‚¿ã‚¹ã‚¯è©³ç´°
PUT    /api/tasks/:id                   // ã‚¿ã‚¹ã‚¯æ›´æ–°
DELETE /api/tasks/:id                   // ã‚¿ã‚¹ã‚¯å‰Šé™¤
PATCH  /api/tasks/:id/status            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´
PATCH  /api/tasks/:id/assign            // ã‚¢ã‚µã‚¤ãƒ³å¤‰æ›´
PATCH  /api/tasks/:id/position          // ä½ç½®å¤‰æ›´ï¼ˆã‚«ãƒ³ãƒãƒ³ç”¨ï¼‰
GET    /api/tasks/:id/comments          // ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§
POST   /api/tasks/:id/comments          // ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆ
GET    /api/tasks/:id/time-entries      // æ™‚é–“ã‚¨ãƒ³ãƒˆãƒªä¸€è¦§
POST   /api/tasks/:id/time-entries      // æ™‚é–“è¨˜éŒ²é–‹å§‹/åœæ­¢
```

#### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚¿ã‚¹ã‚¯
```typescript
GET    /api/projects/:id/tasks          // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯
GET    /api/users/me/tasks              // è‡ªåˆ†ã®ã‚¿ã‚¹ã‚¯
GET    /api/users/:id/tasks             // ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚¹ã‚¯
```

### GraphQL APIï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
```graphql
type Query {
  projects: [Project!]!
  project(id: ID!): Project
  tasks(filter: TaskFilter): [Task!]!
  task(id: ID!): Task
  myTasks(filter: TaskFilter): [Task!]!
}

type Mutation {
  createTask(input: CreateTaskInput!): Task!
  updateTask(id: ID!, input: UpdateTaskInput!): Task!
  updateTaskStatus(id: ID!, status: TaskStatus!): Task!
  assignTask(id: ID!, userId: ID): Task!
}

type Subscription {
  taskUpdated(projectId: ID!): Task!
  projectUpdated(id: ID!): Project!
}
```

## ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã‚·ã‚¹ãƒ†ãƒ 

### Socket.ioæ¥ç¶šç®¡ç†
```typescript
// server/socket.ts
import { Server } from 'socket.io';
import jwt from 'jsonwebtoken';

export const initializeSocket = (server: any) => {
  const io = new Server(server, {
    cors: {
      origin: process.env.FRONTEND_URL,
      credentials: true
    }
  });

  // èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
  io.use(async (socket, next) => {
    try {
      const token = socket.handshake.auth.token;
      const user = jwt.verify(token, process.env.JWT_SECRET!);
      socket.userId = user.id;
      next();
    } catch (err) {
      next(new Error('Authentication error'));
    }
  });

  io.on('connection', (socket) => {
    console.log(`User ${socket.userId} connected`);

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒ ã«å‚åŠ 
    socket.on('join-project', async (projectId) => {
      const isMember = await checkProjectMembership(socket.userId, projectId);
      if (isMember) {
        socket.join(`project:${projectId}`);
        console.log(`User ${socket.userId} joined project:${projectId}`);
      }
    });

    // å€‹äººã‚¿ã‚¹ã‚¯ãƒ«ãƒ¼ãƒ ã«å‚åŠ 
    socket.on('join-user-tasks', () => {
      socket.join(`user:${socket.userId}`);
    });

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å‡º
    socket.on('leave-project', (projectId) => {
      socket.leave(`project:${projectId}`);
    });

    socket.on('disconnect', () => {
      console.log(`User ${socket.userId} disconnected`);
    });
  });

  return io;
};
```

### ã‚¿ã‚¹ã‚¯æ›´æ–°ã®åŒæœŸå‡¦ç†
```typescript
// services/taskService.ts
import { io } from '../socket';
import { TaskEvent } from '../models/TaskEvent';
import { redis } from '../lib/redis';

export class TaskService {
  static async updateTask(taskId: string, updates: Partial<Task>, userId: string) {
    const transaction = await db.transaction();
    
    try {
      // 1. ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ã‚’å–å¾—
      const oldTask = await Task.findById(taskId, { transaction });
      if (!oldTask) {
        throw new Error('Task not found');
      }

      // 2. æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ï¼ˆupdated_atã§ç«¶åˆæ¤œå‡ºï¼‰
      if (updates.lastModified && oldTask.updatedAt > updates.lastModified) {
        throw new ConflictError('Task was modified by another user', oldTask);
      }

      // 3. ã‚¿ã‚¹ã‚¯æ›´æ–°
      const updatedTask = await oldTask.update({
        ...updates,
        updatedAt: new Date()
      }, { transaction });

      // 4. ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã«è¨˜éŒ²
      await TaskEvent.create({
        taskId,
        projectId: updatedTask.projectId,
        userId,
        eventType: this.determineEventType(oldTask, updatedTask),
        oldData: oldTask.toJSON(),
        newData: updatedTask.toJSON()
      }, { transaction });

      await transaction.commit();

      // 5. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é…ä¿¡
      await this.broadcastTaskUpdate(updatedTask, oldTask, userId);

      // 6. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
      await this.invalidateCache(updatedTask.projectId);

      return updatedTask;
      
    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }

  private static async broadcastTaskUpdate(
    newTask: Task, 
    oldTask: Task, 
    userId: string
  ) {
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒãƒ¼ã«é…ä¿¡
    io.to(`project:${newTask.projectId}`).emit('task_updated', {
      task: newTask,
      changes: this.getChanges(oldTask, newTask),
      updatedBy: userId,
      timestamp: new Date()
    });

    // ã‚¢ã‚µã‚¤ãƒ³ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é…ä¿¡ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒãƒ¼ã§ãªã„å ´åˆã‚‚ã‚ã‚Šå¾—ã‚‹ï¼‰
    if (newTask.assignedTo) {
      io.to(`user:${newTask.assignedTo}`).emit('user_task_updated', {
        task: newTask,
        changes: this.getChanges(oldTask, newTask),
        updatedBy: userId
      });
    }

    // ä»¥å‰ã‚¢ã‚µã‚¤ãƒ³ã•ã‚Œã¦ã„ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚‚é€šçŸ¥
    if (oldTask.assignedTo && oldTask.assignedTo !== newTask.assignedTo) {
      io.to(`user:${oldTask.assignedTo}`).emit('user_task_updated', {
        task: newTask,
        changes: this.getChanges(oldTask, newTask),
        updatedBy: userId
      });
    }
  }

  private static determineEventType(oldTask: Task, newTask: Task): TaskEventType {
    if (oldTask.status !== newTask.status) {
      return newTask.status === 'completed' ? 'completed' : 'status_changed';
    }
    if (oldTask.assignedTo !== newTask.assignedTo) {
      return newTask.assignedTo ? 'assigned' : 'unassigned';
    }
    if (oldTask.priority !== newTask.priority) {
      return 'priority_changed';
    }
    return 'updated';
  }
}
```

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ï¼ˆRedisï¼‰
```typescript
// services/cacheService.ts
import { redis } from '../lib/redis';

export class CacheService {
  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚«ãƒ³ãƒãƒ³ãƒœãƒ¼ãƒ‰çŠ¶æ…‹ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  static async getProjectBoard(projectId: string): Promise<KanbanBoard | null> {
    const cacheKey = `project:${projectId}:board`;
    const cached = await redis.get(cacheKey);
    
    if (cached) {
      return JSON.parse(cached);
    }

    const board = await this.buildBoardFromDB(projectId);
    await redis.setex(cacheKey, 300, JSON.stringify(board)); // 5åˆ†ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    
    return board;
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  static async getUserTasks(userId: string, filter?: TaskFilter): Promise<Task[]> {
    const cacheKey = `user:${userId}:tasks:${this.hashFilter(filter)}`;
    const cached = await redis.get(cacheKey);
    
    if (cached) {
      return JSON.parse(cached);
    }

    const tasks = await this.getUserTasksFromDB(userId, filter);
    await redis.setex(cacheKey, 180, JSON.stringify(tasks)); // 3åˆ†ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    
    return tasks;
  }

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
  static async invalidateProjectCache(projectId: string) {
    const patterns = [
      `project:${projectId}:*`,
      `user:*:tasks:*` // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚ç„¡åŠ¹åŒ–ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ãŒå«ã¾ã‚Œã‚‹ãŸã‚ï¼‰
    ];
    
    for (const pattern of patterns) {
      const keys = await redis.keys(pattern);
      if (keys.length > 0) {
        await redis.del(...keys);
      }
    }
  }

  static async invalidateUserCache(userId: string) {
    const pattern = `user:${userId}:*`;
    const keys = await redis.keys(pattern);
    if (keys.length > 0) {
      await redis.del(...keys);
    }
  }

  private static async buildBoardFromDB(projectId: string): Promise<KanbanBoard> {
    const tasks = await Task.findAll({
      where: { projectId, isArchived: false },
      include: [{ model: User, as: 'assignee' }],
      order: [['position', 'ASC']]
    });

    return {
      columns: {
        todo: tasks.filter(t => t.status === 'todo'),
        in_progress: tasks.filter(t => t.status === 'in_progress'),
        review: tasks.filter(t => t.status === 'review'),
        completed: tasks.filter(t => t.status === 'completed'),
        blocked: tasks.filter(t => t.status === 'blocked')
      },
      stats: this.calculateBoardStats(tasks),
      lastUpdated: new Date()
    };
  }
}
```

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆ

### Socket.io ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š
```typescript
// lib/socket.ts
import io, { Socket } from 'socket.io-client';
import { useAuth } from '../contexts/AuthContext';

class SocketService {
  private socket: Socket | null = null;
  private reconnectAttempts = 0;
  private maxReconnectAttempts = 5;

  connect(token: string) {
    if (this.socket) {
      return this.socket;
    }

    this.socket = io(process.env.REACT_APP_API_URL!, {
      auth: { token },
      transports: ['websocket', 'polling'],
      timeout: 20000,
      retries: 3
    });

    this.socket.on('connect', () => {
      console.log('Socket connected');
      this.reconnectAttempts = 0;
    });

    this.socket.on('disconnect', (reason) => {
      console.log('Socket disconnected:', reason);
      if (reason === 'io server disconnect') {
        // ã‚µãƒ¼ãƒãƒ¼å´ã‹ã‚‰åˆ‡æ–­ã•ã‚ŒãŸå ´åˆã¯å†æ¥ç¶š
        this.socket?.connect();
      }
    });

    this.socket.on('connect_error', (error) => {
      console.error('Socket connection error:', error);
      this.handleReconnection();
    });

    return this.socket;
  }

  private handleReconnection() {
    if (this.reconnectAttempts < this.maxReconnectAttempts) {
      this.reconnectAttempts++;
      const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 10000);
      
      setTimeout(() => {
        console.log(`Attempting to reconnect... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
        this.socket?.connect();
      }, delay);
    }
  }

  joinProject(projectId: string) {
    this.socket?.emit('join-project', projectId);
  }

  leaveProject(projectId: string) {
    this.socket?.emit('leave-project', projectId);
  }

  joinUserTasks() {
    this.socket?.emit('join-user-tasks');
  }

  onTaskUpdated(callback: (data: any) => void) {
    this.socket?.on('task_updated', callback);
  }

  onUserTaskUpdated(callback: (data: any) => void) {
    this.socket?.on('user_task_updated', callback);
  }

  offTaskUpdated() {
    this.socket?.off('task_updated');
  }

  offUserTaskUpdated() {
    this.socket?.off('user_task_updated');
  }

  disconnect() {
    this.socket?.disconnect();
    this.socket = null;
  }
}

export const socketService = new SocketService();
```

### ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ãƒ•ãƒƒã‚¯
```typescript
// hooks/useRealtimeSync.ts
import { useEffect, useCallback } from 'react';
import { useQueryClient } from '@tanstack/react-query';
import { socketService } from '../lib/socket';
import { Task } from '../types/task';

export const useRealtimeSync = (projectId?: string, userId?: string) => {
  const queryClient = useQueryClient();

  const handleTaskUpdate = useCallback((data: { task: Task; changes: any; updatedBy: string }) => {
    const { task, updatedBy } = data;

    // è‡ªåˆ†ã®å¤‰æ›´ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ¥½è¦³çš„æ›´æ–°æ¸ˆã¿ï¼‰
    if (updatedBy === userId) {
      return;
    }

    // ã‚¯ã‚¨ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
    queryClient.setQueryData(['tasks'], (oldTasks: Task[] | undefined) => {
      if (!oldTasks) return oldTasks;
      return oldTasks.map(t => t.id === task.id ? task : t);
    });

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
    if (projectId) {
      queryClient.setQueryData([`project:${projectId}:board`], (oldBoard: any) => {
        if (!oldBoard) return oldBoard;
        // ãƒœãƒ¼ãƒ‰ã®è©²å½“ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°
        return updateBoardTask(oldBoard, task);
      });
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¹ã‚¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
    queryClient.setQueryData([`user:${userId}:tasks`], (oldTasks: Task[] | undefined) => {
      if (!oldTasks) return oldTasks;
      return oldTasks.map(t => t.id === task.id ? task : t);
    });

    // é€šçŸ¥è¡¨ç¤º
    if (task.assignedTo === userId && data.changes.includes('status')) {
      showNotification(`ã‚¿ã‚¹ã‚¯ã€Œ${task.title}ã€ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ`);
    }
  }, [queryClient, projectId, userId]);

  useEffect(() => {
    if (!socketService.socket) return;

    if (projectId) {
      socketService.joinProject(projectId);
      socketService.onTaskUpdated(handleTaskUpdate);
    }

    if (userId) {
      socketService.joinUserTasks();
      socketService.onUserTaskUpdated(handleTaskUpdate);
    }

    return () => {
      socketService.offTaskUpdated();
      socketService.offUserTaskUpdated();
      if (projectId) {
        socketService.leaveProject(projectId);
      }
    };
  }, [projectId, userId, handleTaskUpdate]);
};
```

### æ¥½è¦³çš„æ›´æ–°ã®å®Ÿè£…
```typescript
// hooks/useTaskMutations.ts
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { taskAPI } from '../services/api';
import { Task, TaskStatus } from '../types/task';

export const useUpdateTaskStatus = (projectId?: string) => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ taskId, newStatus }: { taskId: string; newStatus: TaskStatus }) =>
      taskAPI.updateTaskStatus(taskId, newStatus),
      
    onMutate: async ({ taskId, newStatus }) => {
      // é€²è¡Œä¸­ã®ã‚¯ã‚¨ãƒªã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      await queryClient.cancelQueries({ queryKey: ['tasks'] });

      // æ¥½è¦³çš„æ›´æ–°
      queryClient.setQueryData(['tasks'], (oldTasks: Task[] | undefined) => {
        if (!oldTasks) return oldTasks;
        return oldTasks.map(task => 
          task.id === taskId 
            ? { ...task, status: newStatus, updatedAt: new Date() }
            : task
        );
      });

      // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒ‰ã‚‚æ¥½è¦³çš„æ›´æ–°
      if (projectId) {
        queryClient.setQueryData([`project:${projectId}:board`], (oldBoard: any) => {
          if (!oldBoard) return oldBoard;
          return optimisticallyUpdateBoard(oldBoard, taskId, newStatus);
        });
      }

      // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’è¿”ã™
      return { previousTasks: queryClient.getQueryData(['tasks']) };
    },

    onError: (err, variables, context) => {
      // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
      if (context?.previousTasks) {
        queryClient.setQueryData(['tasks'], context.previousTasks);
      }
      
      // ã‚¨ãƒ©ãƒ¼é€šçŸ¥
      showErrorNotification('ã‚¿ã‚¹ã‚¯ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
    },

    onSettled: () => {
      // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§å†ãƒ•ã‚§ãƒƒãƒ
      queryClient.invalidateQueries({ queryKey: ['tasks'] });
      if (projectId) {
        queryClient.invalidateQueries({ queryKey: [`project:${projectId}:board`] });
      }
    },
  });
};
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–
```sql
-- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ï¼ˆå¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œï¼‰
CREATE TABLE task_events_2024_12 PARTITION OF task_events
FOR VALUES FROM ('2024-12-01') TO ('2025-01-01');

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ€é©åŒ–
CREATE INDEX CONCURRENTLY idx_tasks_composite 
ON tasks(project_id, status, position) 
WHERE is_archived = false;

-- çµ±è¨ˆæƒ…å ±ã®å®šæœŸæ›´æ–°
SELECT 'ANALYZE tasks;' FROM generate_series(1,1);
```

### 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã®æœ€é©åŒ–
```typescript
// ãƒãƒƒãƒå‡¦ç†ã§ã‚¿ã‚¹ã‚¯ä½ç½®ã‚’æ›´æ–°
export class TaskBatchService {
  static async reorderTasks(
    projectId: string, 
    reorders: Array<{ taskId: string; newPosition: number; newStatus?: TaskStatus }>
  ) {
    const transaction = await db.transaction();
    
    try {
      // ãƒãƒƒãƒã§SQLã‚’å®Ÿè¡Œ
      const updatePromises = reorders.map(({ taskId, newPosition, newStatus }) => {
        const updates: any = { position: newPosition };
        if (newStatus) updates.status = newStatus;
        
        return Task.update(updates, { 
          where: { id: taskId }, 
          transaction 
        });
      });

      await Promise.all(updatePromises);
      await transaction.commit();

      // ä¸€æ‹¬ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
      await CacheService.invalidateProjectCache(projectId);
      
      // WebSocketé€šçŸ¥ã‚‚ä¸€æ‹¬ã§é€ä¿¡
      const updatedTasks = await Task.findAll({
        where: { id: reorders.map(r => r.taskId) },
        include: [{ model: User, as: 'assignee' }]
      });

      io.to(`project:${projectId}`).emit('tasks_reordered', {
        tasks: updatedTasks,
        timestamp: new Date()
      });

    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }
}
```

### 3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æœ€é©åŒ–
```typescript
// ä»®æƒ³åŒ–ã•ã‚ŒãŸã‚«ãƒ³ãƒãƒ³ãƒœãƒ¼ãƒ‰
import { FixedSizeList as List } from 'react-window';

const VirtualizedTaskColumn = ({ tasks, status }: { tasks: Task[]; status: TaskStatus }) => {
  const renderTask = useCallback(({ index, style }: { index: number; style: any }) => (
    <div style={style}>
      <TaskCard key={tasks[index].id} task={tasks[index]} />
    </div>
  ), [tasks]);

  return (
    <List
      height={600}
      itemCount={tasks.length}
      itemSize={120}
      overscanCount={5} // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãŸã‚ãƒ—ãƒªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    >
      {renderTask}
    </List>
  );
};

// ãƒ¡ãƒ¢åŒ–ã«ã‚ˆã‚‹ä¸è¦ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é˜²æ­¢
const TaskCard = memo(({ task }: { task: Task }) => {
  const { mutate: updateStatus } = useUpdateTaskStatus();
  
  const handleStatusChange = useCallback((newStatus: TaskStatus) => {
    updateStatus({ taskId: task.id, newStatus });
  }, [task.id, updateStatus]);

  return (
    // TaskCardã®å®Ÿè£…
  );
}, (prevProps, nextProps) => {
  // æ·±ã„æ¯”è¼ƒã‚’é¿ã‘ã€å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ã¿ãƒã‚§ãƒƒã‚¯
  return (
    prevProps.task.id === nextProps.task.id &&
    prevProps.task.status === nextProps.task.status &&
    prevProps.task.title === nextProps.task.title &&
    prevProps.task.updatedAt.getTime() === nextProps.task.updatedAt.getTime()
  );
});
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

### 1. èªè¨¼ãƒ»èªå¯
```typescript
// JWTèªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
export const authenticateJWT = (req: Request, res: Response, next: NextFunction) => {
  const token = req.header('Authorization')?.replace('Bearer ', '');
  
  if (!token) {
    return res.status(401).json({ error: 'Access token required' });
  }

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET!) as any;
    req.user = decoded;
    next();
  } catch (error) {
    return res.status(403).json({ error: 'Invalid token' });
  }
};

// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãƒã‚§ãƒƒã‚¯
export const checkProjectAccess = (minRole: ProjectMemberRole = 'viewer') => {
  return async (req: Request, res: Response, next: NextFunction) => {
    const { projectId } = req.params;
    const userId = req.user.id;

    const membership = await ProjectMember.findOne({
      where: { projectId, userId }
    });

    if (!membership) {
      return res.status(403).json({ error: 'Access denied' });
    }

    const roleLevel = { viewer: 0, member: 1, admin: 2, owner: 3 };
    if (roleLevel[membership.role] < roleLevel[minRole]) {
      return res.status(403).json({ error: 'Insufficient permissions' });
    }

    req.projectMembership = membership;
    next();
  };
};
```

### 2. ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
```typescript
// Zod ã‚¹ã‚­ãƒ¼ãƒ
import { z } from 'zod';

export const TaskCreateSchema = z.object({
  title: z.string().min(1).max(500),
  description: z.string().max(5000).optional(),
  priority: z.enum(['low', 'medium', 'high', 'urgent']),
  status: z.enum(['todo', 'in_progress', 'review', 'completed', 'blocked', 'cancelled']),
  category: z.enum(['development', 'design', 'marketing', 'content', 'research', 'meeting', 'other']),
  projectId: z.string().uuid(),
  assignedTo: z.string().uuid().optional(),
  dueDate: z.date().optional(),
  estimatedHours: z.number().int().min(0).max(1000).optional(),
  tags: z.array(z.string()).max(10).optional(),
});

// ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
export const validateBody = (schema: z.ZodSchema) => {
  return (req: Request, res: Response, next: NextFunction) => {
    try {
      req.body = schema.parse(req.body);
      next();
    } catch (error) {
      if (error instanceof z.ZodError) {
        return res.status(400).json({ 
          error: 'Validation error', 
          details: error.errors 
        });
      }
      next(error);
    }
  };
};
```

### 3. ãƒ¬ãƒ¼ãƒˆåˆ¶é™
```typescript
import rateLimit from 'express-rate-limit';

// APIå‘¼ã³å‡ºã—åˆ¶é™
export const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†
  max: 100, // æœ€å¤§100ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  message: 'Too many requests from this IP',
  standardHeaders: true,
  legacyHeaders: false,
});

// ã‚¿ã‚¹ã‚¯ä½œæˆã¯å³ã—ãåˆ¶é™
export const taskCreationLimiter = rateLimit({
  windowMs: 60 * 1000, // 1åˆ†
  max: 10, // æœ€å¤§10ã‚¿ã‚¹ã‚¯
  keyGenerator: (req) => req.user?.id || req.ip,
});
```

## é‹ç”¨ãƒ»ç›£è¦–

### 1. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
```typescript
// /health ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
export const healthCheck = async (req: Request, res: Response) => {
  const checks = {
    status: 'ok',
    timestamp: new Date().toISOString(),
    services: {
      database: 'unknown',
      redis: 'unknown',
      socketio: 'unknown'
    },
    version: process.env.npm_package_version || 'unknown'
  };

  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª
  try {
    await db.authenticate();
    checks.services.database = 'ok';
  } catch (error) {
    checks.services.database = 'error';
    checks.status = 'degraded';
  }

  // Redisæ¥ç¶šç¢ºèª
  try {
    await redis.ping();
    checks.services.redis = 'ok';
  } catch (error) {
    checks.services.redis = 'error';
    checks.status = 'degraded';
  }

  // Socket.ioç¢ºèª
  checks.services.socketio = io.engine.clientsCount >= 0 ? 'ok' : 'error';

  res.status(checks.status === 'ok' ? 200 : 503).json(checks);
};
```

### 2. ãƒ­ã‚°è¨­å®š
```typescript
import winston from 'winston';

export const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
    new winston.transports.File({ filename: 'logs/combined.log' }),
  ],
});

// æœ¬ç•ªç’°å¢ƒä»¥å¤–ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ã‚‚
if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.simple()
  }));
}
```

### 3. ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
```typescript
// Prometheus ãƒ¡ãƒˆãƒªã‚¯ã‚¹
import client from 'prom-client';

// ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹
const taskUpdateCounter = new client.Counter({
  name: 'tasks_updated_total',
  help: 'Total number of task updates',
  labelNames: ['project_id', 'status_from', 'status_to']
});

const socketConnectionGauge = new client.Gauge({
  name: 'socket_connections_current',
  help: 'Current number of socket connections'
});

// ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ›´æ–°
export const incrementTaskUpdate = (projectId: string, statusFrom: string, statusTo: string) => {
  taskUpdateCounter.inc({ project_id: projectId, status_from: statusFrom, status_to: statusTo });
};

export const updateSocketConnections = (count: number) => {
  socketConnectionGauge.set(count);
};
```

## ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

### 1. Dockeræ§‹æˆ
```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY package*.json ./
RUN npm ci --only=production

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«
COPY . .

# ãƒ“ãƒ«ãƒ‰
RUN npm run build

EXPOSE 3000

# érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å®Ÿè¡Œ
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nodejs -u 1001
USER nodejs

CMD ["npm", "start"]
```

```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://user:pass@db:5432/taskdb
      - REDIS_URL=redis://redis:6379
    depends_on:
      - db
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  db:
    image: postgres:15
    environment:
      POSTGRES_DB: taskdb
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d taskdb"]

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]

volumes:
  postgres_data:
  redis_data:
```

### 2. CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆGitHub Actionsï¼‰
```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - run: npm ci
      - run: npm run test
      - run: npm run lint
      - run: npm run type-check

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Build and push Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_REGISTRY }}/task-api:${{ github.sha }} .
          docker push ${{ secrets.DOCKER_REGISTRY }}/task-api:${{ github.sha }}
      
      - name: Deploy to production
        run: |
          # Railway CLI ã¾ãŸã¯AWS CLIç­‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤
```

## é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç’°å¢ƒ

### 1. é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
# 1. ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³
git clone <repository-url>
cd task-management-backend

# 2. ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# 3. ç’°å¢ƒå¤‰æ•°è¨­å®š
cp .env.example .env.local
# .env.local ã‚’ç·¨é›†

# 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èµ·å‹•ï¼ˆDockerï¼‰
docker-compose up -d db redis

# 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
npm run db:migrate
npm run db:seed

# 6. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
npm run dev
```

### 2. ãƒ†ã‚¹ãƒˆæ§‹æˆ
```typescript
// tests/integration/tasks.test.ts
import request from 'supertest';
import { app } from '../../src/app';
import { setupTestDB, teardownTestDB } from '../helpers/database';

describe('Task API', () => {
  beforeAll(async () => {
    await setupTestDB();
  });

  afterAll(async () => {
    await teardownTestDB();
  });

  describe('POST /api/tasks', () => {
    it('should create a new task', async () => {
      const taskData = {
        title: 'Test Task',
        description: 'Test description',
        priority: 'medium',
        status: 'todo',
        category: 'development',
        projectId: 'test-project-id'
      };

      const response = await request(app)
        .post('/api/tasks')
        .set('Authorization', `Bearer ${testToken}`)
        .send(taskData)
        .expect(201);

      expect(response.body).toMatchObject({
        title: taskData.title,
        description: taskData.description,
        priority: taskData.priority
      });
    });
  });

  describe('Socket.io Events', () => {
    it('should broadcast task updates to project members', async () => {
      const client = await connectSocket(testToken);
      
      client.emit('join-project', 'test-project-id');
      
      // ã‚¿ã‚¹ã‚¯æ›´æ–°
      await request(app)
        .put(`/api/tasks/${testTaskId}`)
        .set('Authorization', `Bearer ${testToken}`)
        .send({ status: 'in_progress' })
        .expect(200);

      // Socket.ioã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡ç¢ºèª
      await expect(client).toReceiveEvent('task_updated', {
        timeout: 1000
      });
    });
  });
});
```

## ä»Šå¾Œã®æ‹¡å¼µäºˆå®š

### ãƒ•ã‚§ãƒ¼ã‚º2: é«˜åº¦ãªæ©Ÿèƒ½
- **AIæ”¯æ´**: ã‚¿ã‚¹ã‚¯ã®è‡ªå‹•åˆ†é¡ãƒ»å„ªå…ˆåº¦ææ¡ˆ
- **æ™‚é–“äºˆæ¸¬**: éå»ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãå·¥æ•°äºˆæ¸¬
- **ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º
- **ã‚«ã‚¹ã‚¿ãƒ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

### ãƒ•ã‚§ãƒ¼ã‚º3: ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºæ©Ÿèƒ½
- **ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ**: çµ„ç¹”å˜ä½ã§ã®ç®¡ç†
- **é«˜åº¦ãªæ¨©é™ç®¡ç†**: ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- **ç›£æŸ»ãƒ­ã‚°**: è©³ç´°ãªå¤‰æ›´å±¥æ­´è¿½è·¡
- **APIåˆ¶é™**: çµ„ç¹”åˆ¥ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™

---

# æ®µéšçš„ç§»è¡Œè¨ˆç”»

## ãƒ•ã‚§ãƒ¼ã‚º1: åŸºç›¤æ•´å‚™ï¼ˆ2-3é€±é–“ï¼‰

### ç›®æ¨™
- çµ±åˆèªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰
- çµ±ä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è¨­è¨ˆãƒ»å®Ÿè£…
- åŸºæœ¬çš„ãªAPIçµ±åˆåŸºç›¤ã®æ§‹ç¯‰

### å®Ÿè£…å†…å®¹
1. **çµ±åˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ**
   - unified_users ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
   - user_permissions ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
   - æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æºãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

2. **çµ±åˆèªè¨¼ã‚·ã‚¹ãƒ†ãƒ **
   - JWTçµ±åˆèªè¨¼ã®å®Ÿè£…
   - WordPressèªè¨¼ã¨ã®é€£æº
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

3. **åŸºæœ¬APIçµ±åˆ**
   - APIã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã®åŸºæœ¬æ§‹é€ 
   - èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®å®Ÿè£…
   - åŸºæœ¬çš„ãªæ¨©é™ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½

### å®Œäº†åŸºæº–
- [ ] çµ±åˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã®ãƒ­ã‚°ã‚¤ãƒ³ãŒå¯èƒ½
- [ ] WordPress ã¨ ã‚¿ã‚¹ã‚¯ã‚·ã‚¹ãƒ†ãƒ ä¸¡æ–¹ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- [ ] åŸºæœ¬çš„ãªæ¨©é™ç®¡ç†ãŒå‹•ä½œ

## ãƒ•ã‚§ãƒ¼ã‚º2: ç·¨é›†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè£…ï¼ˆ3-4é€±é–“ï¼‰

### ç›®æ¨™
- è¨˜äº‹åŸ·ç­†ã‹ã‚‰ã‚¿ã‚¹ã‚¯ç®¡ç†ã¸ã®çµ±åˆæ©Ÿèƒ½å®Ÿè£…
- ç·¨é›†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰

### å®Ÿè£…å†…å®¹
1. **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«**
   - editorial_workflows ãƒ†ãƒ¼ãƒ–ãƒ«
   - workflow_tasks é€£æºãƒ†ãƒ¼ãƒ–ãƒ«
   - workflow_history å±¥æ­´ç®¡ç†

2. **ç·¨é›†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ©Ÿèƒ½**
   - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä½œæˆãƒ»ç®¡ç†
   - ã‚¹ãƒ†ãƒ¼ã‚¸é·ç§»ã®è‡ªå‹•åŒ–
   - WordPressè¨˜äº‹ã¨ã®é€£æº

3. **ã‚¿ã‚¹ã‚¯è‡ªå‹•ç”Ÿæˆ**
   - è¨˜äº‹ä¼ç”»ã‹ã‚‰ã‚¿ã‚¹ã‚¯ç”Ÿæˆ
   - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¸é€£å‹•
   - æ‹…å½“è€…è‡ªå‹•ã‚¢ã‚µã‚¤ãƒ³

### å®Œäº†åŸºæº–
- [ ] è¨˜äº‹ä¼ç”»ã‹ã‚‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒä½œæˆå¯èƒ½
- [ ] ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¸ã¨ã‚¿ã‚¹ã‚¯ãŒé€£å‹•
- [ ] WordPressè¨˜äº‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒåŒæœŸ

## ãƒ•ã‚§ãƒ¼ã‚º3: çµ±åˆUIå®Ÿè£…ï¼ˆ4-5é€±é–“ï¼‰

### ç›®æ¨™
- çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®å®Ÿè£…
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸæ©Ÿèƒ½ã®æ§‹ç¯‰
- ä¸€å…ƒåŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å®Ÿç¾

### å®Ÿè£…å†…å®¹
1. **çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**
   - çµ±ä¸€çŠ¶æ…‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
   - çµ±åˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
   - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ

2. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½**
   - Socket.ioçµ±åˆ
   - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¿ã‚¹ã‚¯æ›´æ–°
   - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çŠ¶æ…‹åŒæœŸ

3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“çµ±åˆ**
   - Single Sign-Onå®Ÿè£…
   - çµ±åˆé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
   - æ¨©é™ãƒ™ãƒ¼ã‚¹UIè¡¨ç¤º

### å®Œäº†åŸºæº–
- [ ] çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒè¡¨ç¤º
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ãŒå‹•ä½œ
- [ ] ã™ã¹ã¦ã®æ©Ÿèƒ½ã«ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

## ãƒ•ã‚§ãƒ¼ã‚º4: æœ€é©åŒ–ãƒ»é‹ç”¨æº–å‚™ï¼ˆ2-3é€±é–“ï¼‰

### ç›®æ¨™
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- ç›£è¦–ãƒ»ãƒ­ã‚°æ©Ÿèƒ½ã®æ•´å‚™
- æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™

### å®Ÿè£…å†…å®¹
1. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®å®Ÿè£…
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªæœ€é©åŒ–
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æœ€é©åŒ–

2. **ç›£è¦–ãƒ»ãƒ­ã‚°**
   - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç›£è¦–
   - ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–

3. **æœ¬ç•ªç’°å¢ƒæº–å‚™**
   - DockeråŒ–
   - CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»

### å®Œäº†åŸºæº–
- [ ] æœ¬ç•ªç’°å¢ƒã§ã®å®‰å®šç¨¼åƒ
- [ ] ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½ãŒå‹•ä½œ
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†

---

# æŠ€è¡“é¸å®šã¨æ¨å¥¨æ§‹æˆ

## é–‹ç™ºç’°å¢ƒæ¨å¥¨æ§‹æˆ

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
```json
{
  "name": "coral-unified-platform",
  "dependencies": {
    "react": "^19.0.0",
    "typescript": "^5.0.0",
    "@tanstack/react-query": "^5.0.0",
    "socket.io-client": "^4.7.0",
    "@emotion/react": "^11.11.0",
    "@emotion/styled": "^11.11.0",
    "framer-motion": "^12.0.0",
    "react-router-dom": "^7.0.0",
    "date-fns": "^3.0.0",
    "react-window": "^1.8.8",
    "react-beautiful-dnd": "^13.1.1"
  },
  "devDependencies": {
    "vite": "^6.0.0",
    "@vitejs/plugin-react": "^4.0.0",
    "vitest": "^2.0.0",
    "@testing-library/react": "^16.0.0"
  }
}
```

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
```json
{
  "name": "coral-unified-backend",
  "dependencies": {
    "express": "^4.19.0",
    "socket.io": "^4.7.0",
    "pg": "^8.11.0",
    "sequelize": "^6.35.0",
    "redis": "^4.6.0",
    "jsonwebtoken": "^9.0.0",
    "bcryptjs": "^2.4.3",
    "zod": "^3.22.0",
    "winston": "^3.11.0",
    "helmet": "^7.1.0",
    "cors": "^2.8.5",
    "express-rate-limit": "^7.1.0"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "typescript": "^5.0.0",
    "nodemon": "^3.0.0",
    "jest": "^29.0.0",
    "supertest": "^7.0.0"
  }
}
```

## ã‚¤ãƒ³ãƒ•ãƒ©æ¨å¥¨æ§‹æˆ

### é–‹ç™ºç’°å¢ƒ
```yaml
# docker-compose.dev.yml
version: '3.8'
services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - VITE_API_URL=http://localhost:3000

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    volumes:
      - ./backend:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://coral:coral@db:5432/coral_dev
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=dev_secret_key
    depends_on:
      - db
      - redis

  db:
    image: postgres:15
    environment:
      POSTGRES_DB: coral_dev
      POSTGRES_USER: coral
      POSTGRES_PASSWORD: coral
    volumes:
      - postgres_dev:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_dev:/data

  wordpress:
    image: wordpress:6.4-php8.1-apache
    environment:
      WORDPRESS_DB_HOST: wp_db
      WORDPRESS_DB_NAME: wordpress
      WORDPRESS_DB_USER: wp_user
      WORDPRESS_DB_PASSWORD: wp_pass
    volumes:
      - wordpress_data:/var/www/html
    ports:
      - "8080:80"
    depends_on:
      - wp_db

  wp_db:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wp_user
      MYSQL_PASSWORD: wp_pass
      MYSQL_ROOT_PASSWORD: root_pass
    volumes:
      - mysql_data:/var/lib/mysql

volumes:
  postgres_dev:
  redis_dev:
  wordpress_data:
  mysql_data:
```

### æœ¬ç•ªç’°å¢ƒï¼ˆRailway/Vercelæ¨å¥¨ï¼‰

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (Vercel)
```json
{
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/static-build"
    }
  ],
  "env": {
    "VITE_API_URL": "@api_url",
    "VITE_WS_URL": "@websocket_url"
  }
}
```

#### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Railway)
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build
EXPOSE 3000
CMD ["npm", "start"]
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š

### ç’°å¢ƒå¤‰æ•°ç®¡ç†
```bash
# .env.production
NODE_ENV=production
DATABASE_URL=${RAILWAY_POSTGRESQL_URL}
REDIS_URL=${RAILWAY_REDIS_URL}
JWT_SECRET=${JWT_SECRET_KEY}
WORDPRESS_API_URL=${WP_API_URL}
CORS_ORIGIN=${FRONTEND_URL}
SESSION_SECRET=${SESSION_SECRET}
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
```typescript
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'", process.env.WS_URL!]
    }
  },
  crossOriginEmbedderPolicy: false
}));
```

---

# é‹ç”¨ãƒ»ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹è¨ˆç”»

## ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°è¨­å®š

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç›£è¦–
```typescript
// ç›£è¦–è¨­å®š
import { createPrometheusMetrics } from './monitoring/prometheus';
import { setupHealthCheck } from './monitoring/health';

const metrics = createPrometheusMetrics();

// ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹
export const trackUserAction = (action: string, userId: string) => {
  metrics.userActions.inc({ action, user: userId });
};

export const trackWorkflowTransition = (from: string, to: string) => {
  metrics.workflowTransitions.inc({ from_stage: from, to_stage: to });
};
```

### ãƒ­ã‚°ç®¡ç†
```typescript
import winston from 'winston';
import 'winston-daily-rotate-file';

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.DailyRotateFile({
      filename: 'logs/application-%DATE%.log',
      datePattern: 'YYYY-MM-DD',
      maxSize: '20m',
      maxFiles: '14d'
    }),
    new winston.transports.DailyRotateFile({
      level: 'error',
      filename: 'logs/error-%DATE%.log',
      datePattern: 'YYYY-MM-DD',
      maxSize: '20m',
      maxFiles: '30d'
    })
  ]
});
```

## ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
```bash
#!/bin/bash
# backup.sh
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backups"
DB_NAME="coral_production"

# PostgreSQL ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
pg_dump $DATABASE_URL > $BACKUP_DIR/db_backup_$DATE.sql

# Redis ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
redis-cli --rdb $BACKUP_DIR/redis_backup_$DATE.rdb

# å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å‰Šé™¤ï¼ˆ30æ—¥ä»¥ä¸ŠçµŒéï¼‰
find $BACKUP_DIR -name "*.sql" -mtime +30 -delete
find $BACKUP_DIR -name "*.rdb" -mtime +30 -delete

echo "Backup completed: $DATE"
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
```typescript
// ã‚­ãƒ£ãƒƒã‚·ãƒ¥éšå±¤
export class CacheManager {
  // Level 1: ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ (Node.js)
  private memoryCache = new Map();
  
  // Level 2: Redis ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  private redis: Redis;
  
  async get(key: string) {
    // ãƒ¡ãƒ¢ãƒªã‹ã‚‰å–å¾—
    if (this.memoryCache.has(key)) {
      return this.memoryCache.get(key);
    }
    
    // Redisã‹ã‚‰å–å¾—
    const cached = await this.redis.get(key);
    if (cached) {
      const data = JSON.parse(cached);
      this.memoryCache.set(key, data);
      return data;
    }
    
    return null;
  }
  
  async set(key: string, value: any, ttl: number = 300) {
    // ãƒ¡ãƒ¢ãƒªã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    this.memoryCache.set(key, value);
    
    // Redisã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    await this.redis.setex(key, ttl, JSON.stringify(value));
  }
}
```

ã“ã®çµ±åˆè¨­è¨ˆã«ã‚ˆã‚Šã€åŠ¹ç‡çš„ã§æ‹¡å¼µæ€§ã®é«˜ã„CORALçµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚æ®µéšçš„ãªç§»è¡Œè¨ˆç”»ã«ã‚ˆã‚Šã€ãƒªã‚¹ã‚¯ã‚’æœ€å°åŒ–ã—ãªãŒã‚‰çµ±åˆã‚’é€²ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚